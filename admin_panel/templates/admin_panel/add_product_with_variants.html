{% extends 'admin_panel/base.html' %}

{% block title %}Add Product with Variants{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Add New Product with Variants</h3>
                </div>
                <div class="card-body">
                    <form id="productForm" method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- Basic Product Information -->
                        <div class="row">
                            <div class="col-md-6">
                                <h4>Basic Information</h4>
                                <div class="form-group">
                                    <label for="name">Product Name *</label>
                                    <input type="text" class="form-control" id="name" name="name" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="description">Description *</label>
                                    <textarea class="form-control" id="description" name="description" rows="4" required></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="main_category">Main Category *</label>
                                    <select class="form-control" id="main_category" name="main_category" required onchange="loadSubcategories()">
                                        <option value="">Select Main Category</option>
                                    </select>
                                    <small class="form-text text-muted">Choose the main category (e.g., لوحات فنية, نسيج بإبداع)</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="subcategory">Subcategory (Optional)</label>
                                    <select class="form-control" id="subcategory" name="subcategory" onchange="loadCategoryVariants()">
                                        <option value="">Select Subcategory (or leave empty for main category)</option>
                                    </select>
                                    <small class="form-text text-muted">Choose a subcategory if you want to assign the product to a specific subcategory</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="base_price">Base Price (ج.م) *</label>
                                    <input type="number" step="0.01" class="form-control" id="base_price" name="base_price" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="stock_quantity">Stock Quantity</label>
                                    <input type="number" min="0" class="form-control" id="stock_quantity" name="stock_quantity" value="0">
                                    <small class="form-text text-muted">For products without variants (like تحف نادرة, لمسات منزليه). Leave 0 if using variants below.</small>
                                </div>
                                
                                <div class="form-group">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="is_featured" name="is_featured">
                                        <label class="form-check-label" for="is_featured">Featured Product</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h4>Product Images</h4>
                                <div class="form-group">
                                    <label for="images">Product Images</label>
                                    <input type="file" class="form-control-file" id="images" name="images" multiple accept="image/*">
                                    <small class="form-text text-muted">Select multiple images. First image will be primary.</small>
                                </div>
                                
                                <div id="image-preview" class="row mt-3"></div>
                            </div>
                        </div>
                        
                        <!-- Product Variants -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h4>Product Variants</h4>
                                <div id="variants-section" style="display: none;">
                                    <div class="alert alert-info">
                                        Select the colors and sizes available for this product. Variants will be generated automatically.
                                    </div>
                                    
                                    <!-- Frame Colors -->
                                    <div id="frame-colors-section" class="mb-4" style="display: none;">
                                        <h5>Frame Colors (لون الاطار)</h5>
                                        <div id="frame-colors-list" class="row"></div>
                                    </div>
                                    
                                    <!-- Sizes -->
                                    <div id="sizes-section" class="mb-4" style="display: none;">
                                        <h5>Sizes (الحجم)</h5>
                                        <div id="sizes-list" class="row"></div>
                                    </div>
                                    
                                    <!-- Other Variants -->
                                    <div id="other-variants-section" class="mb-4"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Variants Preview -->
                        <div class="row mt-4" id="variants-preview-section" style="display: none;">
                            <div class="col-12">
                                <h4>Generated Variants</h4>
                                <div class="alert alert-warning">
                                    The following variants will be created. You can set stock and price adjustments for each.
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="variants-table">
                                        <thead>
                                            <tr>
                                                <th>Variant</th>
                                                <th>Stock Count</th>
                                                <th>Price Adjustment (ج.م)</th>
                                                <th>Final Price</th>
                                                <th>Active</th>
                                            </tr>
                                        </thead>
                                        <tbody id="variants-tbody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Submit Buttons -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <button type="button" class="btn btn-secondary" onclick="previewVariants()">
                                    Preview Variants
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Create Product with Variants
                                </button>
                                <a href="{% url 'admin_panel:product_management' %}" class="btn btn-light">
                                    Cancel
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function() {
    console.log('Document ready - starting initialization...');
    
    // Load categories first (public API, no auth needed)
    loadCategories();
    
    // Then test authentication for admin features
    testAuthentication();
    setupImagePreview();
    setupFormSubmission();
    setupBasePriceListener();
});

let allVariants = {};
let selectedVariants = {};

function testAuthentication() {
    console.log('Testing authentication...');
    $.ajax({
        url: '/api/admin/test/auth/',
        method: 'GET',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Authentication test successful:', response);
        },
        error: function(xhr) {
            console.error('Authentication test failed:', xhr.status, xhr.statusText);
            if (xhr.status === 401 || xhr.status === 403) {
                showAlert('Authentication failed. Please log in as admin.', 'danger');
                setTimeout(function() {
                    window.location.href = '/dashboard/login/';
                }, 2000);
            }
        }
    });
}

function loadCategories() {
    // console.log('SIMPLE: Loading categories...');
    
    // Test if jQuery works
    if (typeof $ === 'undefined') {
        console.error('SIMPLE: jQuery not loaded!');
        return;
    }
    
    // Test if element exists
    var select = document.getElementById('main_category');
    if (!select) {
        console.error('SIMPLE: main_category element not found!');
        return;
    }
    
    // console.log('SIMPLE: Element found, making request...');
    
    // Try with vanilla fetch first
    fetch('/api/products/categories/')
        .then(function(response) {
            // console.log('SIMPLE: Response status:', response.status);
            return response.json();
        })
        .then(function(data) {
            // console.log('SIMPLE: Got data:', data ? data.length : 'null');
            
            // Clear dropdown
            select.innerHTML = '<option value="">Select Main Category</option>';
            
            // Add some categories
            if (data && data.length) {
                for (var i = 0; i < Math.min(data.length, 5); i++) {
                    if (data[i] && data[i].name) {
                        var option = document.createElement('option');
                        option.value = data[i].id;
                        option.textContent = data[i].name;
                        select.appendChild(option);
                        // console.log('SIMPLE: Added', data[i].name);
                    }
                }
                // console.log('SIMPLE: Done - dropdown has', select.options.length, 'options');
            }
        })
        .catch(function(error) {
            console.error('SIMPLE: Error:', error);
        });
}

function loadSubcategories() {
    // console.log('DEBUG: loadSubcategories called');
    const mainCategoryId = $('#main_category').val();
    // console.log('DEBUG: Selected main category ID:', mainCategoryId);
    const subcategorySelect = $('#subcategory');
    
    // Reset subcategory dropdown
    subcategorySelect.empty().append('<option value="">Select Subcategory (or leave empty for main category)</option>');
    
    if (!mainCategoryId) {
        // Reset attributes section when no main category selected
        $('#variants-section').hide();
        return;
    }
    
    // Load attributes for main category immediately
    // console.log('DEBUG: About to call loadCategoryVariants()');
    loadCategoryVariants();
    
    // console.log('Loading subcategories for main category:', mainCategoryId);
    
    $.ajax({
        url: '/api/products/categories/',
        method: 'GET',
        success: function(response) {
            // console.log('All categories loaded for subcategory filtering:', response);
            
            if (Array.isArray(response) && response.length > 0) {
                // Filter subcategories that belong to the selected main category
                const subcategories = response.filter(function(category) {
                    return category.parent && category.parent.toString() === mainCategoryId.toString();
                });
                
                // console.log('Filtering subcategories for main category ID:', mainCategoryId);
                // console.log('Found subcategories:', subcategories.map(sub => sub.name));
                
                subcategories.forEach(function(subcategory) {
                    subcategorySelect.append('<option value="' + subcategory.id + '">' + subcategory.name + '</option>');
                });
                
                // console.log(subcategories.length + ' subcategories added to dropdown');
            }
        },
        error: function(xhr) {
            console.error('Subcategories loading failed:', xhr.status, xhr.statusText, xhr.responseText);
            showAlert('Failed to load subcategories', 'warning');
        }
    });
}

function loadCategoryVariants() {
    // console.log('DEBUG: loadCategoryVariants called');
    // Always use main category for variants since variants depend on main category
    const subcategoryId = $('#subcategory').val();
    const mainCategoryId = $('#main_category').val();
    const categoryId = mainCategoryId; // Always use main category for variants
    // console.log('DEBUG: subcategoryId:', subcategoryId, 'mainCategoryId:', mainCategoryId, 'using categoryId:', categoryId, '(always main category for variants)');
    
    if (!categoryId) {
        $('#variants-section').hide();
        return;
    }

    // console.log('Loading category variants for category:', categoryId);
    // console.log('Using subcategory:', subcategoryId ? 'Yes' : 'No');
    
    $.ajax({
        url: '/api/products/categories/' + categoryId + '/variants/',
        method: 'GET',
        success: function(response) {
            // console.log('DEBUG: Category variants loaded:', response);
            // console.log('DEBUG: Response is array?', Array.isArray(response) ? 'YES (' + response.length + ')' : 'NO');
            // console.log('DEBUG: Response has variants property?', response.variants ? 'YES (' + response.variants.length + ')' : 'NO');
            allVariants = {};
            selectedVariants = {};
            
            // Reset sections
            $('#frame-colors-section').hide();
            $('#sizes-section').hide();
            $('#other-variants-section').empty();
            
            // Handle both response formats: direct array or object with variants property
            const variants = Array.isArray(response) ? response : (response.variants || []);
            console.log('DEBUG: Final variants to process:', variants.length);
            
            if (variants && variants.length > 0) {
                variants.forEach(function(variantType) {
                    console.log('DEBUG: Processing variant type:', variantType);
                    console.log('DEBUG: Variant name:', variantType.name);
                    console.log('DEBUG: Options count:', variantType.options ? variantType.options.length : 'NO OPTIONS');
                    
                    if (!variantType.name) {
                        console.error('ERROR: Variant type has no name property:', variantType);
                        return; // Skip this variant
                    }
                    
                    allVariants[variantType.id] = variantType;
                    selectedVariants[variantType.id] = [];
                    
                    // Check variant type name to determine display style
                    const lowerName = variantType.name.toLowerCase();
                    if (lowerName.includes('لون') || lowerName.includes('إطار') || lowerName.includes('color')) {
                        renderColors(variantType);
                    } else if (lowerName.includes('حجم') || lowerName.includes('size')) {
                        renderSizes(variantType);
                    } else {
                        renderOtherVariant(variantType);
                    }
                });
                
                // console.log('DEBUG: Showing variants section...');
                $('#variants-section').show();
                // console.log('DEBUG: Variants section display:', $('#variants-section').css('display'));
            } else {
                console.log('No variants found for this category');
                $('#variants-section').hide();
            }
        },
        error: function(xhr) {
            console.error('Category variants error:', xhr.status, xhr.statusText, xhr.responseText);
            if (xhr.status !== 404) { // Don't show error for categories without variants
                showAlert('Failed to load category variants: ' + getErrorMessage(xhr), 'warning');
            }
            $('#variants-section').hide();
        }
    });
}

function renderColors(variantType) {
    const container = $('#frame-colors-list');
    container.empty();
    
    variantType.options.forEach(function(option) {
        
        // Simple color display for CategoryVariantOptions (no color_code field)
        container.append(
            '<div class="col-md-3 mb-2">' +
                '<div class="form-check">' +
                    '<input class="form-check-input" type="checkbox" id="color_' + option.id + '"' + 
                           ' value="' + option.id + '" onchange="updateSelectedVariant(' + variantType.id + ', ' + option.id + ', this.checked)">' +
                    '<label class="form-check-label" for="color_' + option.id + '">' +
                        option.value +
                        (option.extra_price > 0 ? ' (+' + option.extra_price + ' ج.م)' : '') +
                    '</label>' +
                '</div>' +
            '</div>'
        );
    });
    
    $('#frame-colors-section').show();
}

function renderSizes(variantType) {
    const container = $('#sizes-list');
    container.empty();
    
    variantType.options.forEach(function(option) {
        
        container.append(
            '<div class="col-md-3 mb-2">' +
                '<div class="form-check">' +
                    '<input class="form-check-input" type="checkbox" id="size_' + option.id + '"' + 
                           ' value="' + option.id + '" onchange="updateSelectedVariant(' + variantType.id + ', ' + option.id + ', this.checked)">' +
                    '<label class="form-check-label" for="size_' + option.id + '">' +
                        option.value +
                        (option.extra_price > 0 ? ' (+' + option.extra_price + ' ج.م)' : '') +
                    '</label>' +
                '</div>' +
            '</div>'
        );
    });
    
    $('#sizes-section').show();
}

function renderOtherVariant(variantType) {
    const container = $('#other-variants-section');
    
    const requiredText = variantType.is_required ? ' *' : '';
    let optionsHtml = '';
    
    variantType.options.forEach(function(option) {
        
        optionsHtml += 
            '<div class="col-md-3 mb-2">' +
                '<div class="form-check">' +
                    '<input class="form-check-input" type="checkbox" id="variant_' + variantType.id + '_' + option.id + '"' + 
                           ' value="' + option.id + '" onchange="updateSelectedVariant(' + variantType.id + ', ' + option.id + ', this.checked)">' +
                    '<label class="form-check-label" for="variant_' + variantType.id + '_' + option.id + '">' +
                        option.value +
                        (option.extra_price > 0 ? ' (+' + option.extra_price + ' ج.م)' : '') +
                    '</label>' +
                '</div>' +
            '</div>';
    });
    
    container.append(
        '<div class="mb-4">' +
            '<h5>' + variantType.name + requiredText + '</h5>' +
            '<div class="row">' + optionsHtml + '</div>' +
        '</div>'
    );
}

function updateSelectedVariant(variantTypeId, optionId, isSelected) {
    // console.log('DEBUG: updateSelectedVariant called:', variantTypeId, optionId, isSelected);
    
    if (!selectedVariants[variantTypeId]) {
        selectedVariants[variantTypeId] = [];
    }
    
    if (isSelected) {
        if (!selectedVariants[variantTypeId].includes(optionId)) {
            selectedVariants[variantTypeId].push(optionId);
            // console.log('DEBUG: Added option', optionId, 'to variant type', variantTypeId);
        }
    } else {
        selectedVariants[variantTypeId] = selectedVariants[variantTypeId].filter(function(id) { return id !== optionId; });
        // console.log('DEBUG: Removed option', optionId, 'from variant type', variantTypeId);
    }
    
    // console.log('DEBUG: Current selectedVariants:', selectedVariants);
    
    // Auto-preview variants when attributes are selected
    autoPreviewVariants();
}

function autoPreviewVariants() {
    // console.log('DEBUG: autoPreviewVariants called');
    // console.log('DEBUG: selectedVariants state:', selectedVariants);
    
    // Check if at least one variant type has selections
    const hasSelections = Object.keys(selectedVariants).some(variantTypeId => selectedVariants[variantTypeId].length > 0);
    // console.log('DEBUG: hasSelections:', hasSelections);
    
    if (hasSelections) {
        const variants = generateVariantCombinations();
        // console.log('DEBUG: Generated variants:', variants.length);
        if (variants.length > 0) {
            renderVariantsTable(variants);
            $('#variants-preview-section').show();
            // console.log('DEBUG: Variants preview section shown');
        }
    } else {
        $('#variants-preview-section').hide();
        // console.log('DEBUG: Variants preview section hidden - no selections');
    }
}

function previewVariants() {
    const variants = generateVariantCombinations();
    if (variants.length === 0) {
        showAlert('Please select at least one option from each attribute to generate variants.', 'warning');
        return;
    }
    
    renderVariantsTable(variants);
    $('#variants-preview-section').show();
}

function generateVariantCombinations() {
    const variantTypeIds = Object.keys(selectedVariants);
    const validVariantTypes = variantTypeIds.filter(variantTypeId => selectedVariants[variantTypeId].length > 0);
    
    if (validVariantTypes.length === 0) return [];
    
    // Generate all combinations
    const combinations = cartesianProduct(validVariantTypes.map(variantTypeId => 
        selectedVariants[variantTypeId].map(optionId => ({
            variantTypeId: variantTypeId,
            optionId: optionId,
            option: findOptionById(variantTypeId, optionId),
            variantType: allVariants[variantTypeId]
        }))
    ));
    
    return combinations;
}

function cartesianProduct(arrays) {
    return arrays.reduce((acc, curr) => 
        acc.flatMap(a => curr.map(c => [...a, c])), [[]]
    );
}

function findOptionById(variantTypeId, optionId) {
    const variantType = allVariants[variantTypeId];
    return variantType ? variantType.attribute.options.find(function(opt) { return opt.id === optionId; }) : null;
}

function renderVariantsTable(variants) {
    const tbody = $('#variants-tbody');
    tbody.empty();
    
    const basePrice = parseFloat($('#base_price').val()) || 0;
    
    variants.forEach(function(variant, index) {
        // Calculate the variant name and total extra price
        const variantName = variant.map(function(attr) { return attr.option.value; }).join(' - ');
        const totalExtraPrice = variant.reduce(function(sum, attr) { return sum + (attr.option.extra_price || 0); }, 0);
        const defaultPrice = basePrice + totalExtraPrice;
        
        tbody.append(
            '<tr>' +
                '<td>' +
                    variantName +
                    '<input type="hidden" class="variant-options" data-variant="' + index + '"' + 
                           ' value="' + JSON.stringify(variant.map(function(attr) { return attr.optionId; })).replace(/"/g, '&quot;') + '">' +
                '</td>' +
                '<td>' +
                    '<input type="number" class="form-control variant-stock"' + 
                           ' data-variant="' + index + '" min="0" value="0">' +
                '</td>' +
                '<td>' +
                    '<input type="number" class="form-control variant-price-adj" step="0.01"' + 
                           ' data-variant="' + index + '" value="' + totalExtraPrice + '" onchange="updateFinalPrice(' + index + ')">' +
                '</td>' +
                '<td>' +
                    '<span class="final-price" data-variant="' + index + '">' + defaultPrice.toFixed(2) + ' ج.م</span>' +
                '</td>' +
                '<td>' +
                    '<input type="checkbox" class="form-check-input variant-active"' + 
                           ' data-variant="' + index + '" checked>' +
                '</td>' +
            '</tr>'
        );
    });
}

function updateFinalPrice(variantIndex) {
    const basePrice = parseFloat($('#base_price').val()) || 0;
    const adjustment = parseFloat($('.variant-price-adj[data-variant="' + variantIndex + '"]').val()) || 0;
    const finalPrice = basePrice + adjustment;
    
    $('.final-price[data-variant="' + variantIndex + '"]').text(finalPrice.toFixed(2) + ' ج.م');
}

function setupImagePreview() {
    $('#images').on('change', function() {
        const files = this.files;
        const preview = $('#image-preview');
        preview.empty();
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.append(
                        '<div class="col-md-3 mb-2">' +
                            '<div class="card">' +
                                '<img src="' + e.target.result + '" class="card-img-top" style="height: 150px; object-fit: cover;">' +
                                '<div class="card-body p-2">' +
                                    '<small class="text-muted">' + (i === 0 ? 'Primary' : 'Secondary') + '</small>' +
                                '</div>' +
                            '</div>' +
                        '</div>'
                    );
                };
                reader.readAsDataURL(file);
            }
        }
    });
}

function setupBasePriceListener() {
    $('#base_price').on('input', function() {
        // Update all final prices when base price changes
        $('#variants-tbody tr').each(function(index) {
            updateFinalPrice(index);
        });
    });
}

function setupFormSubmission() {
    $('#productForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        // Determine final category: subcategory if selected, otherwise main category
        const subcategoryId = $('#subcategory').val();
        const mainCategoryId = $('#main_category').val();
        const finalCategoryId = subcategoryId || mainCategoryId;
        
        if (!finalCategoryId) {
            showAlert('Please select at least a main category', 'danger');
            return;
        }
        
        // Remove the separate category fields and add the final category
        formData.delete('main_category');
        formData.delete('subcategory');
        formData.append('category', finalCategoryId);
        
        
        // Add selected variant options - now we store which specific variant combination options were selected
        const selectedVariantData = [];
        const variantRows = $('#variants-tbody tr');
        console.log('DEBUG: Total variant rows found:', variantRows.length);
        
        $('#variants-tbody tr').each(function(index) {
            const $row = $(this);
            const optionIds = JSON.parse($row.find('.variant-options').val() || '[]');
            const stockCount = parseInt($row.find('.variant-stock').val()) || 0;
            const priceAdjustment = parseFloat($row.find('.variant-price-adj').val()) || 0;
            const isActive = $row.find('.variant-active').is(':checked');
            
            console.log(`DEBUG: Row ${index}:`, {
                optionIds: optionIds,
                stockCount: stockCount,
                priceAdjustment: priceAdjustment,
                isActive: isActive,
                willInclude: isActive && stockCount > 0
            });
            
            if (isActive && stockCount > 0) { // Only include active variants with stock
                optionIds.forEach(optionId => {
                    selectedVariantData.push({
                        option_id: optionId,
                        stock_count: stockCount,
                        price_adjustment: priceAdjustment
                    });
                });
            }
        });
        
        console.log('DEBUG: Final selectedVariantData:', selectedVariantData);
        formData.append('variants_data', JSON.stringify(selectedVariantData));
        
        // Convert checkbox values to proper booleans
        const isFeatured = $('#is_featured').is(':checked');
        formData.delete('is_featured'); // Remove the original "on" value
        formData.append('is_featured', isFeatured ? 'true' : 'false');
        
        $.ajax({
            url: '/api/admin/products/admin/create-with-variants/',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                showAlert('Product created successfully with ' + response.variants_created + ' variants!', 'success');
                setTimeout(function() {
                    window.location.href = '/dashboard/products/';
                }, 2000);
            },
            error: function(xhr) {
                console.error('Form submission error:', xhr.status, xhr.statusText, xhr.responseText);
                showAlert('Failed to create product: ' + getErrorMessage(xhr), 'danger');
            }
        });
    });
}

function showAlert(message, type) {
    const alert = $(
        '<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">' +
            message +
            '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
        '</div>'
    );
    
    $('.card-body').prepend(alert);
    
    setTimeout(function() {
        alert.fadeOut();
    }, 5000);
}

function getErrorMessage(xhr) {
    if (xhr.responseJSON && xhr.responseJSON.error) {
        return xhr.responseJSON.error;
    }
    return xhr.statusText || 'Unknown error';
}
</script>

<style>
.color-preview {
    border-radius: 3px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.table th, .table td {
    vertical-align: middle;
}

.form-check-input:checked {
    background-color: #007bff;
    border-color: #007bff;
}

.alert {
    margin-bottom: 1rem;
}
</style>
{% endblock %}