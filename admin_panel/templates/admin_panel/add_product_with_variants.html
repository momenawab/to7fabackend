{% extends 'admin_panel/base.html' %}

{% block title %}Add Product with Variants{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Add New Product with Variants</h3>
                </div>
                <div class="card-body">
                    <form id="productForm" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- Basic Product Information -->
                        <div class="row">
                            <div class="col-md-6">
                                <h4>Basic Information</h4>
                                <div class="form-group">
                                    <label for="name">Product Name *</label>
                                    <input type="text" class="form-control" id="name" name="name" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="description">Description *</label>
                                    <textarea class="form-control" id="description" name="description" rows="4" required></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="category">Category *</label>
                                    <select class="form-control" id="category" name="category" required onchange="loadCategoryAttributes()">
                                        <option value="">Select Category</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="base_price">Base Price (ج.م) *</label>
                                    <input type="number" step="0.01" class="form-control" id="base_price" name="base_price" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="stock_quantity">Stock Quantity</label>
                                    <input type="number" min="0" class="form-control" id="stock_quantity" name="stock_quantity" value="0">
                                    <small class="form-text text-muted">For products without variants (like تحف نادرة, لمسات منزليه). Leave 0 if using variants below.</small>
                                </div>
                                
                                <div class="form-group">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="is_featured" name="is_featured">
                                        <label class="form-check-label" for="is_featured">Featured Product</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h4>Product Images</h4>
                                <div class="form-group">
                                    <label for="images">Product Images</label>
                                    <input type="file" class="form-control-file" id="images" name="images" multiple accept="image/*">
                                    <small class="form-text text-muted">Select multiple images. First image will be primary.</small>
                                </div>
                                
                                <div id="image-preview" class="row mt-3"></div>
                            </div>
                        </div>
                        
                        <!-- Product Attributes -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h4>Product Attributes</h4>
                                <div id="attributes-section" style="display: none;">
                                    <div class="alert alert-info">
                                        Select the colors and sizes available for this product. Variants will be generated automatically.
                                    </div>
                                    
                                    <!-- Frame Colors -->
                                    <div id="frame-colors-section" class="mb-4" style="display: none;">
                                        <h5>Frame Colors (لون الاطار)</h5>
                                        <div id="frame-colors-list" class="row"></div>
                                    </div>
                                    
                                    <!-- Sizes -->
                                    <div id="sizes-section" class="mb-4" style="display: none;">
                                        <h5>Sizes (الحجم)</h5>
                                        <div id="sizes-list" class="row"></div>
                                    </div>
                                    
                                    <!-- Other Attributes -->
                                    <div id="other-attributes-section" class="mb-4"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Variants Preview -->
                        <div class="row mt-4" id="variants-section" style="display: none;">
                            <div class="col-12">
                                <h4>Generated Variants</h4>
                                <div class="alert alert-warning">
                                    The following variants will be created. You can set stock and price adjustments for each.
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="variants-table">
                                        <thead>
                                            <tr>
                                                <th>Variant</th>
                                                <th>Stock Count</th>
                                                <th>Price Adjustment (ج.م)</th>
                                                <th>Final Price</th>
                                                <th>Active</th>
                                            </tr>
                                        </thead>
                                        <tbody id="variants-tbody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Submit Buttons -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <button type="button" class="btn btn-secondary" onclick="previewVariants()">
                                    Preview Variants
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Create Product with Variants
                                </button>
                                <a href="{% url 'admin_panel:product_management' %}" class="btn btn-light">
                                    Cancel
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function() {
    // First test authentication
    testAuthentication();
    loadCategories();
    setupImagePreview();
    setupFormSubmission();
    setupBasePriceListener();
});

let allAttributes = {};
let selectedAttributes = {};

function testAuthentication() {
    console.log('Testing authentication...');
    $.ajax({
        url: '/api/admin/test/auth/',
        method: 'GET',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Authentication test successful:', response);
        },
        error: function(xhr) {
            console.error('Authentication test failed:', xhr.status, xhr.statusText);
            if (xhr.status === 401 || xhr.status === 403) {
                showAlert('Authentication failed. Please log in as admin.', 'danger');
                setTimeout(() => {
                    window.location.href = '/dashboard/login/';
                }, 2000);
            }
        }
    });
}

function loadCategories() {
    console.log('Loading categories...');
    console.log('CSRF Token:', $('[name=csrfmiddlewaretoken]').val());
    console.log('Current URL:', window.location.href);
    console.log('API URL:', '/dashboard/api/categories/');
    
    $.ajax({
        url: '/dashboard/api/categories/',
        method: 'GET',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Categories loaded successfully:', response);
            const select = $('#category');
            select.empty().append('<option value="">Select Category</option>');
            
            if (Array.isArray(response) && response.length > 0) {
                response.forEach(category => {
                    select.append(`<option value="${category.id}">${category.name}</option>`);
                });
                console.log('Categories added to dropdown');
            } else {
                console.warn('No categories received or invalid response format');
                showAlert('No categories found', 'warning');
            }
        },
        error: function(xhr, textStatus, errorThrown) {
            console.error('Categories loading failed:');
            console.error('Status:', xhr.status);
            console.error('Status Text:', xhr.statusText);
            console.error('Response Text:', xhr.responseText);
            console.error('Text Status:', textStatus);
            console.error('Error Thrown:', errorThrown);
            console.error('Request headers:', xhr.getAllResponseHeaders());
            
            let errorMessage = 'Failed to load categories';
            if (xhr.status === 403) {
                errorMessage = 'Access denied. Please make sure you are logged in as admin.';
            } else if (xhr.status === 401) {
                errorMessage = 'Authentication required. Please log in again.';
            } else if (xhr.status === 404) {
                errorMessage = 'Categories API endpoint not found. Please check the URL configuration.';
            } else if (xhr.responseText) {
                try {
                    const errorData = JSON.parse(xhr.responseText);
                    errorMessage = errorData.detail || errorData.error || errorMessage;
                } catch (e) {
                    // Check if it's an HTML error page
                    if (xhr.responseText.includes('DisallowedHost') || xhr.responseText.includes('ALLOWED_HOSTS')) {
                        errorMessage = 'Server configuration error. Please check ALLOWED_HOSTS.';
                    } else {
                        errorMessage += ': ' + xhr.statusText;
                    }
                }
            }
            
            showAlert(errorMessage, 'danger');
        }
    });
}

function loadCategoryAttributes() {
    const categoryId = $('#category').val();
    if (!categoryId) {
        $('#attributes-section').hide();
        return;
    }

    console.log('Loading category variants for category:', categoryId);
    $.ajax({
        url: `/dashboard/api/categories/${categoryId}/variants/`,
        method: 'GET',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Category variants loaded:', response);
            allAttributes = {};
            selectedAttributes = {};
            
            // Reset sections
            $('#frame-colors-section').hide();
            $('#sizes-section').hide();
            $('#other-attributes-section').empty();
            
            response.variants.forEach(variantType => {
                allAttributes[variantType.id] = variantType;
                selectedAttributes[variantType.id] = [];
                
                // Check variant type name to determine display style
                const lowerName = variantType.name.toLowerCase();
                if (lowerName.includes('لون') || lowerName.includes('إطار') || lowerName.includes('color')) {
                    renderColors(variantType);
                } else if (lowerName.includes('حجم') || lowerName.includes('size')) {
                    renderSizes(variantType);
                } else {
                    renderOtherVariant(variantType);
                }
            });
            
            $('#attributes-section').show();
        },
        error: function(xhr) {
            console.error('Category variants error:', xhr.status, xhr.statusText, xhr.responseText);
            showAlert('Failed to load category variants: ' + getErrorMessage(xhr), 'danger');
        }
    });
}

function renderColors(variantType) {
    const container = $('#frame-colors-list');
    container.empty();
    
    variantType.options.forEach(option => {
        if (!option.is_active) return;
        
        // Simple color display for CategoryVariantOptions (no color_code field)
        container.append(`
            <div class="col-md-3 mb-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="color_${option.id}" 
                           value="${option.id}" onchange="updateSelectedAttribute(${variantType.id}, ${option.id}, this.checked)">
                    <label class="form-check-label" for="color_${option.id}">
                        ${option.value}
                        ${option.extra_price > 0 ? ` (+${option.extra_price} ج.م)` : ''}
                    </label>
                </div>
            </div>
        `);
    });
    
    $('#frame-colors-section').show();
}

function renderSizes(variantType) {
    const container = $('#sizes-list');
    container.empty();
    
    variantType.options.forEach(option => {
        if (!option.is_active) return;
        
        container.append(`
            <div class="col-md-3 mb-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="size_${option.id}" 
                           value="${option.id}" onchange="updateSelectedAttribute(${variantType.id}, ${option.id}, this.checked)">
                    <label class="form-check-label" for="size_${option.id}">
                        ${option.value}
                        ${option.extra_price > 0 ? ` (+${option.extra_price} ج.م)` : ''}
                    </label>
                </div>
            </div>
        `);
    });
    
    $('#sizes-section').show();
}

function renderOtherVariant(variantType) {
    const container = $('#other-attributes-section');
    
    const requiredText = variantType.is_required ? ' *' : '';
    let optionsHtml = '';
    
    variantType.options.forEach(option => {
        if (!option.is_active) return;
        
        optionsHtml += `
            <div class="col-md-3 mb-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="variant_${variantType.id}_${option.id}" 
                           value="${option.id}" onchange="updateSelectedAttribute(${variantType.id}, ${option.id}, this.checked)">
                    <label class="form-check-label" for="variant_${variantType.id}_${option.id}">
                        ${option.value}
                        ${option.extra_price > 0 ? ` (+${option.extra_price} ج.م)` : ''}
                    </label>
                </div>
            </div>
        `;
    });
    
    container.append(`
        <div class="mb-4">
            <h5>${variantType.name}${requiredText}</h5>
            <div class="row">${optionsHtml}</div>
        </div>
    `);
}

function updateSelectedAttribute(variantTypeId, optionId, isSelected) {
    if (!selectedAttributes[variantTypeId]) {
        selectedAttributes[variantTypeId] = [];
    }
    
    if (isSelected) {
        if (!selectedAttributes[variantTypeId].includes(optionId)) {
            selectedAttributes[variantTypeId].push(optionId);
        }
    } else {
        selectedAttributes[variantTypeId] = selectedAttributes[variantTypeId].filter(id => id !== optionId);
    }
    
    // Auto-preview variants when attributes are selected
    autoPreviewVariants();
}

function autoPreviewVariants() {
    // Check if at least one variant type has selections
    const hasSelections = Object.keys(selectedAttributes).some(variantTypeId => selectedAttributes[variantTypeId].length > 0);
    
    if (hasSelections) {
        const variants = generateVariantCombinations();
        if (variants.length > 0) {
            renderVariantsTable(variants);
            $('#variants-section').show();
        }
    } else {
        $('#variants-section').hide();
    }
}

function previewVariants() {
    const variants = generateVariantCombinations();
    if (variants.length === 0) {
        showAlert('Please select at least one option from each attribute to generate variants.', 'warning');
        return;
    }
    
    renderVariantsTable(variants);
    $('#variants-section').show();
}

function generateVariantCombinations() {
    const variantTypeIds = Object.keys(selectedAttributes);
    const validVariantTypes = variantTypeIds.filter(variantTypeId => selectedAttributes[variantTypeId].length > 0);
    
    if (validVariantTypes.length === 0) return [];
    
    // Generate all combinations
    const combinations = cartesianProduct(validVariantTypes.map(variantTypeId => 
        selectedAttributes[variantTypeId].map(optionId => ({
            variantTypeId: variantTypeId,
            optionId: optionId,
            option: findOptionById(variantTypeId, optionId),
            variantType: allAttributes[variantTypeId]
        }))
    ));
    
    return combinations;
}

function cartesianProduct(arrays) {
    return arrays.reduce((acc, curr) => 
        acc.flatMap(a => curr.map(c => [...a, c])), [[]]
    );
}

function findOptionById(variantTypeId, optionId) {
    const variantType = allAttributes[variantTypeId];
    return variantType ? variantType.options.find(opt => opt.id === optionId) : null;
}

function renderVariantsTable(variants) {
    const tbody = $('#variants-tbody');
    tbody.empty();
    
    const basePrice = parseFloat($('#base_price').val()) || 0;
    
    variants.forEach((variant, index) => {
        // Calculate the variant name and total extra price
        const variantName = variant.map(attr => `${attr.option.value}`).join(' - ');
        const totalExtraPrice = variant.reduce((sum, attr) => sum + (attr.option.extra_price || 0), 0);
        const defaultPrice = basePrice + totalExtraPrice;
        
        tbody.append(`
            <tr>
                <td>
                    ${variantName}
                    <input type="hidden" class="variant-options" data-variant="${index}" 
                           value='${JSON.stringify(variant.map(attr => attr.optionId))}'>
                </td>
                <td>
                    <input type="number" class="form-control variant-stock" 
                           data-variant="${index}" min="0" value="0">
                </td>
                <td>
                    <input type="number" class="form-control variant-price-adj" step="0.01" 
                           data-variant="${index}" value="${totalExtraPrice}" onchange="updateFinalPrice(${index})">
                </td>
                <td>
                    <span class="final-price" data-variant="${index}">${defaultPrice.toFixed(2)} ج.م</span>
                </td>
                <td>
                    <input type="checkbox" class="form-check-input variant-active" 
                           data-variant="${index}" checked>
                </td>
            </tr>
        `);
    });
}

function updateFinalPrice(variantIndex) {
    const basePrice = parseFloat($('#base_price').val()) || 0;
    const adjustment = parseFloat($(`.variant-price-adj[data-variant="${variantIndex}"]`).val()) || 0;
    const finalPrice = basePrice + adjustment;
    
    $(`.final-price[data-variant="${variantIndex}"]`).text(`${finalPrice.toFixed(2)} ج.م`);
}

function setupImagePreview() {
    $('#images').on('change', function() {
        const files = this.files;
        const preview = $('#image-preview');
        preview.empty();
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.append(`
                        <div class="col-md-3 mb-2">
                            <div class="card">
                                <img src="${e.target.result}" class="card-img-top" style="height: 150px; object-fit: cover;">
                                <div class="card-body p-2">
                                    <small class="text-muted">${i === 0 ? 'Primary' : 'Secondary'}</small>
                                </div>
                            </div>
                        </div>
                    `);
                };
                reader.readAsDataURL(file);
            }
        }
    });
}

function setupBasePriceListener() {
    $('#base_price').on('input', function() {
        // Update all final prices when base price changes
        $('#variants-tbody tr').each(function(index) {
            updateFinalPrice(index);
        });
    });
}

function setupFormSubmission() {
    $('#productForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        // Add selected variant options - now we store which specific combination options were selected
        const selectedVariantData = [];
        $('#variants-tbody tr').each(function(index) {
            const $row = $(this);
            const optionIds = JSON.parse($row.find('.variant-options').val());
            const stockCount = parseInt($row.find('.variant-stock').val()) || 0;
            const priceAdjustment = parseFloat($row.find('.variant-price-adj').val()) || 0;
            const isActive = $row.find('.variant-active').is(':checked');
            
            if (isActive && stockCount > 0) { // Only include active variants with stock
                optionIds.forEach(optionId => {
                    selectedVariantData.push({
                        option_id: optionId,
                        stock_count: stockCount,
                        price_adjustment: priceAdjustment
                    });
                });
            }
        });
        
        formData.append('selected_variants', JSON.stringify(selectedVariantData));
        
        // Convert checkbox values to proper booleans
        const isFeatured = $('#is_featured').is(':checked');
        formData.delete('is_featured'); // Remove the original "on" value
        formData.append('is_featured', isFeatured ? 'true' : 'false');
        
        $.ajax({
            url: '/api/admin/products/admin/create-with-variants/',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                showAlert('Product created successfully with ' + response.variants_created + ' variants!', 'success');
                setTimeout(() => {
                    window.location.href = '/dashboard/products/';
                }, 2000);
            },
            error: function(xhr) {
                console.error('Form submission error:', xhr.status, xhr.statusText, xhr.responseText);
                showAlert('Failed to create product: ' + getErrorMessage(xhr), 'danger');
            }
        });
    });
}

function showAlert(message, type) {
    const alert = $(`
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);
    
    $('.card-body').prepend(alert);
    
    setTimeout(() => {
        alert.fadeOut();
    }, 5000);
}

function getErrorMessage(xhr) {
    if (xhr.responseJSON && xhr.responseJSON.error) {
        return xhr.responseJSON.error;
    }
    return xhr.statusText || 'Unknown error';
}
</script>

<style>
.color-preview {
    border-radius: 3px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.table th, .table td {
    vertical-align: middle;
}

.form-check-input:checked {
    background-color: #007bff;
    border-color: #007bff;
}

.alert {
    margin-bottom: 1rem;
}
</style>
{% endblock %}