{% extends "admin_panel/base.html" %}
{% load static %}

{% block title %}Seller Ad Requests - TO7FA Admin{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        color: white;
        margin-bottom: 20px;
    }
    .stats-card .card-body {
        padding: 1.5rem;
    }
    .stats-card h3 {
        margin-bottom: 0;
        font-size: 2rem;
        font-weight: bold;
    }
    .stats-card p {
        margin-bottom: 0;
        opacity: 0.8;
    }
    .request-card {
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        transition: transform 0.2s;
    }
    .request-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .status-badge {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-weight: 600;
    }
    .status-pending { background-color: #ffeeba; color: #856404; }
    .status-approved { background-color: #d4edda; color: #155724; }
    .status-active { background-color: #d1ecf1; color: #0c5460; }
    .status-rejected { background-color: #f8d7da; color: #721c24; }
    .status-completed { background-color: #e2e3e5; color: #383d41; }
    
    .ad-type-badge {
        font-size: 0.7rem;
        padding: 0.3rem 0.6rem;
        border-radius: 15px;
        font-weight: 600;
        text-transform: uppercase;
    }
    .ad-type-home_slider { background-color: #e3f2fd; color: #0d47a1; }
    .ad-type-category_slider { background-color: #e8f5e8; color: #2e7d32; }
    .ad-type-offer_ad { background-color: #fff3e0; color: #e65100; }
    .ad-type-featured_product { background-color: #f3e5f5; color: #4a148c; }
    
    .filter-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .detail-row {
        border-bottom: 1px solid #eee;
        padding: 8px 0;
    }
    .detail-row:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">Seller Ad Requests Management</h1>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="row">
        <div class="col-md-2">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <h3>{{ stats.total }}</h3>
                    <p>Total Requests</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card stats-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                <div class="card-body text-center">
                    <h3 style="color: #8b4513;">{{ stats.pending }}</h3>
                    <p style="color: #8b4513;">Pending</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card stats-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                <div class="card-body text-center">
                    <h3 style="color: #2d5016;">{{ stats.approved }}</h3>
                    <p style="color: #2d5016;">Approved</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card stats-card" style="background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);">
                <div class="card-body text-center">
                    <h3 style="color: #003d82;">{{ stats.active }}</h3>
                    <p style="color: #003d82;">Active</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card stats-card" style="background: linear-gradient(135deg, #fdbb2d 0%, #22c1c3 100%);">
                <div class="card-body text-center">
                    <h3 style="color: #1a1a2e;">{{ stats.rejected }}</h3>
                    <p style="color: #1a1a2e;">Rejected</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card stats-card" style="background: linear-gradient(135deg, #ee9ca7 0%, #ffdde1 100%);">
                <div class="card-body text-center">
                    <h3 style="color: #6d4c41;">{{ stats.completed }}</h3>
                    <p style="color: #6d4c41;">Completed</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filter-section">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label for="ad_type" class="form-label">Ad Type</label>
                <select class="form-select" id="ad_type" name="ad_type">
                    <option value="">All Types</option>
                    <option value="home_slider" {% if request.GET.ad_type == 'home_slider' %}selected{% endif %}>Home Page Slider</option>
                    <option value="category_slider" {% if request.GET.ad_type == 'category_slider' %}selected{% endif %}>Category Slider</option>
                    <option value="offer_ad" {% if request.GET.ad_type == 'offer_ad' %}selected{% endif %}>Special Offer</option>
                    <option value="featured_product" {% if request.GET.ad_type == 'featured_product' %}selected{% endif %}>Featured Product</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" name="status">
                    <option value="">All Status</option>
                    <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="approved" {% if request.GET.status == 'approved' %}selected{% endif %}>Approved</option>
                    <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>Active</option>
                    <option value="rejected" {% if request.GET.status == 'rejected' %}selected{% endif %}>Rejected</option>
                    <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Completed</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="search" class="form-label">Search</label>
                <input type="text" class="form-control" id="search" name="search" value="{{ request.GET.search }}" placeholder="Search by seller name or product...">
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button type="submit" class="btn btn-primary">Filter</button>
                    <a href="{% url 'admin_panel:seller_ad_requests' %}" class="btn btn-secondary">Clear</a>
                </div>
            </div>
        </form>
    </div>

    <!-- Requests List -->
    <div class="row">
        {% for request in requests %}
        <div class="col-md-6 col-lg-4">
            <div class="card request-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <span class="ad-type-badge ad-type-{{ request.ad_type.type }}">
                            {{ request.ad_type.get_name_display }}
                        </span>
                    </div>
                    <span class="status-badge status-{{ request.status }}">
                        {{ request.get_status_display }}
                    </span>
                </div>
                <div class="card-body">
                    <h6 class="card-title">{{ request.seller.username }}</h6>
                    <p class="card-text text-muted small">
                        <i class="fas fa-calendar-alt"></i> {{ request.created_at|date:"M d, Y" }}
                    </p>
                    {% if request.product_name %}
                    <p class="card-text">
                        <strong>Product:</strong> {{ request.product_name|truncatechars:30 }}
                    </p>
                    {% endif %}
                    {% if request.special_offer_percentage %}
                    <p class="card-text">
                        <strong>Offer:</strong> {{ request.special_offer_percentage }}% off
                    </p>
                    {% endif %}
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="fas fa-money-bill-wave"></i> 
                            ${{ request.total_cost|floatformat:2 }}
                        </small>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewDetails({{ request.id }})">
                            View Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle fa-2x mb-3"></i>
                <h5>No Ad Requests Found</h5>
                <p>There are no ad requests matching your current filters.</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if requests.has_other_pages %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if requests.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?{% if request.GET.ad_type %}ad_type={{ request.GET.ad_type }}&{% endif %}{% if request.GET.status %}status={{ request.GET.status }}&{% endif %}{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}page={{ requests.previous_page_number }}">Previous</a>
                </li>
            {% endif %}
            
            {% for num in requests.paginator.page_range %}
                {% if requests.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% else %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if request.GET.ad_type %}ad_type={{ request.GET.ad_type }}&{% endif %}{% if request.GET.status %}status={{ request.GET.status }}&{% endif %}{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}page={{ num }}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}
            
            {% if requests.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?{% if request.GET.ad_type %}ad_type={{ request.GET.ad_type }}&{% endif %}{% if request.GET.status %}status={{ request.GET.status }}&{% endif %}{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}page={{ requests.next_page_number }}">Next</a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Ad Details Modal -->
<div class="modal fade" id="adDetailsModal" tabindex="-1" aria-labelledby="adDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="adDetailsModalLabel">Ad Request Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="adDetailsContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function viewDetails(requestId) {
    const modal = new bootstrap.Modal(document.getElementById('adDetailsModal'));
    const modalBody = document.getElementById('adDetailsContent');
    
    // Show loading spinner
    modalBody.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    // Fetch request details
    fetch(`/dashboard/api/ad-bookings/${requestId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            renderAdDetails(data);
        })
        .catch(error => {
            console.error('Error fetching ad details:', error);
            modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Error loading ad details. Please try again.
                </div>
            `;
        });
}

function renderAdDetails(data) {
    const modalBody = document.getElementById('adDetailsContent');
    
    let imageSection = '';
    if (data.images && data.images.length > 0) {
        const imagesList = data.images.map(img => `
            <div class="col-md-4 mb-2">
                <img src="${img.image}" class="img-thumbnail" style="max-height: 150px;" alt="Ad Image">
            </div>
        `).join('');
        imageSection = `
            <div class="row mb-3">
                <div class="col-12">
                    <h6>Images:</h6>
                    <div class="row">
                        ${imagesList}
                    </div>
                </div>
            </div>
        `;
    }
    
    let offerSection = '';
    if (data.special_offer_percentage) {
        offerSection = `
            <div class="detail-row">
                <div class="row">
                    <div class="col-4"><strong>Special Offer:</strong></div>
                    <div class="col-8">${data.special_offer_percentage}% discount</div>
                </div>
            </div>
        `;
    }
    
    let notesSection = '';
    if (data.admin_notes) {
        notesSection = `
            <div class="detail-row">
                <div class="row">
                    <div class="col-4"><strong>Admin Notes:</strong></div>
                    <div class="col-8">${data.admin_notes}</div>
                </div>
            </div>
        `;
    }
    
    modalBody.innerHTML = `
        <div class="container-fluid">
            ${imageSection}
            
            <div class="detail-row">
                <div class="row">
                    <div class="col-4"><strong>Ad Type:</strong></div>
                    <div class="col-8">
                        <span class="ad-type-badge ad-type-${data.ad_type.type}">
                            ${data.ad_type.name}
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="detail-row">
                <div class="row">
                    <div class="col-4"><strong>Seller:</strong></div>
                    <div class="col-8">${data.seller.username}</div>
                </div>
            </div>
            
            <div class="detail-row">
                <div class="row">
                    <div class="col-4"><strong>Status:</strong></div>
                    <div class="col-8">
                        <span class="status-badge status-${data.status}">
                            ${data.status_display}
                        </span>
                    </div>
                </div>
            </div>
            
            ${data.product_name ? `
            <div class="detail-row">
                <div class="row">
                    <div class="col-4"><strong>Product Name:</strong></div>
                    <div class="col-8">${data.product_name}</div>
                </div>
            </div>
            ` : ''}
            
            ${data.description ? `
            <div class="detail-row">
                <div class="row">
                    <div class="col-4"><strong>Description:</strong></div>
                    <div class="col-8">${data.description}</div>
                </div>
            </div>
            ` : ''}
            
            ${offerSection}
            
            <div class="detail-row">
                <div class="row">
                    <div class="col-4"><strong>Duration:</strong></div>
                    <div class="col-8">${data.duration_value} ${data.duration_type}</div>
                </div>
            </div>
            
            <div class="detail-row">
                <div class="row">
                    <div class="col-4"><strong>Total Cost:</strong></div>
                    <div class="col-8"><strong>$${parseFloat(data.total_cost).toFixed(2)}</strong></div>
                </div>
            </div>
            
            <div class="detail-row">
                <div class="row">
                    <div class="col-4"><strong>Created:</strong></div>
                    <div class="col-8">${new Date(data.created_at).toLocaleDateString()}</div>
                </div>
            </div>
            
            ${data.approved_at ? `
            <div class="detail-row">
                <div class="row">
                    <div class="col-4"><strong>Approved:</strong></div>
                    <div class="col-8">${new Date(data.approved_at).toLocaleDateString()}</div>
                </div>
            </div>
            ` : ''}
            
            ${data.start_date ? `
            <div class="detail-row">
                <div class="row">
                    <div class="col-4"><strong>Start Date:</strong></div>
                    <div class="col-8">${new Date(data.start_date).toLocaleDateString()}</div>
                </div>
            </div>
            ` : ''}
            
            ${data.end_date ? `
            <div class="detail-row">
                <div class="row">
                    <div class="col-4"><strong>End Date:</strong></div>
                    <div class="col-8">${new Date(data.end_date).toLocaleDateString()}</div>
                </div>
            </div>
            ` : ''}
            
            ${notesSection}
        </div>
    `;
}
</script>
{% endblock %}