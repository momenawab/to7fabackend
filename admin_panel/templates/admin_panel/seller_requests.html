{% extends "admin_panel/base.html" %}
{% load static %}

{% block title %}Seller Requests Management - TO7FA Admin{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<style>
    .status-pending-payment { background-color: #fff3cd; color: #856404; }
    .status-payment-completed { background-color: #d1ecf1; color: #0c5460; }
    .status-under-review { background-color: #f8d7da; color: #721c24; }
    .status-approved { background-color: #d4edda; color: #155724; }
    .status-rejected { background-color: #f5c2c7; color: #842029; }
    
    .request-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 20px;
        background: white;
    }
    
    .request-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px 8px 0 0;
    }
    
    .request-body {
        padding: 20px;
    }
    
    .btn-purple {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
    }
    
    .btn-purple:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        color: white;
    }
    
    .stats-card {
        border-radius: 15px;
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: transform 0.3s;
    }
    
    .stats-card:hover {
        transform: translateY(-2px);
    }
    
    .nav-pills .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-handshake me-2"></i>
                    Seller Requests Management
                </h2>
                <button class="btn btn-purple" onclick="refreshRequests()">
                    <i class="fas fa-sync-alt me-2"></i>Refresh
                </button>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-percent fa-2x text-warning mb-3"></i>
                            <h4 id="totalOfferRequests">0</h4>
                            <p class="text-muted mb-0">Offer Requests</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-star fa-2x text-primary mb-3"></i>
                            <h4 id="totalFeaturedRequests">0</h4>
                            <p class="text-muted mb-0">Featured Requests</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-clock fa-2x text-info mb-3"></i>
                            <h4 id="pendingRequests">0</h4>
                            <p class="text-muted mb-0">Pending Approval</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-money-bill-wave fa-2x text-success mb-3"></i>
                            <h4 id="totalRevenue">0 EGP</h4>
                            <p class="text-muted mb-0">Total Revenue</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs for different request types -->
            <ul class="nav nav-pills mb-4" id="requestTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="offer-tab" data-bs-toggle="pill" data-bs-target="#offer-requests" 
                            type="button" role="tab" aria-controls="offer-requests" aria-selected="true">
                        <i class="fas fa-percent me-2"></i>Offer Requests
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="featured-tab" data-bs-toggle="pill" data-bs-target="#featured-requests" 
                            type="button" role="tab" aria-controls="featured-requests" aria-selected="false">
                        <i class="fas fa-star me-2"></i>Featured Requests
                    </button>
                </li>
            </ul>

            <!-- Tab content -->
            <div class="tab-content" id="requestTabsContent">
                <!-- Offer Requests Tab -->
                <div class="tab-pane fade show active" id="offer-requests" role="tabpanel" aria-labelledby="offer-tab">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-percent me-2"></i>Offer Requests
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="offerRequestsTable" class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>ID</th>
                                            <th>Product</th>
                                            <th>Seller</th>
                                            <th>Discount</th>
                                            <th>Price</th>
                                            <th>Period</th>
                                            <th>Fee</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Dynamic content will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Featured Requests Tab -->
                <div class="tab-pane fade" id="featured-requests" role="tabpanel" aria-labelledby="featured-tab">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-star me-2"></i>Featured Product Requests
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="featuredRequestsTable" class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>ID</th>
                                            <th>Product</th>
                                            <th>Seller</th>
                                            <th>Duration</th>
                                            <th>Priority</th>
                                            <th>Fee</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Dynamic content will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Request Details Modal -->
<div class="modal fade" id="requestDetailsModal" tabindex="-1" aria-labelledby="requestDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="requestDetailsModalLabel">Request Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="requestDetailsBody">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="approveBtn" onclick="processRequest('approve')">
                    <i class="fas fa-check me-2"></i>Approve
                </button>
                <button type="button" class="btn btn-danger" id="rejectBtn" onclick="processRequest('reject')">
                    <i class="fas fa-times me-2"></i>Reject
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Mark Payment Completed Modal -->
<div class="modal fade" id="markPaymentModal" tabindex="-1" aria-labelledby="markPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="markPaymentModalLabel">Mark Payment as Completed</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="paymentForm">
                    <div class="mb-3">
                        <label for="paymentReference" class="form-label">Payment Reference</label>
                        <input type="text" class="form-control" id="paymentReference" required 
                               placeholder="Enter payment transaction reference">
                    </div>
                    <div class="mb-3">
                        <label for="adminNotes" class="form-label">Admin Notes (Optional)</label>
                        <textarea class="form-control" id="adminNotes" rows="3" 
                                  placeholder="Add any notes about this request..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="markPaymentCompleted()">
                    <i class="fas fa-check me-2"></i>Confirm Payment
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
let offerRequestsTable;
let featuredRequestsTable;
let currentRequestId = null;
let currentRequestType = null;

$(document).ready(function() {
    initializeTables();
    loadSellerRequests();
});

function initializeTables() {
    offerRequestsTable = $('#offerRequestsTable').DataTable({
        responsive: true,
        pageLength: 25,
        order: [[8, 'desc']], // Sort by created date
        columnDefs: [
            { orderable: false, targets: [9] } // Actions column
        ]
    });

    featuredRequestsTable = $('#featuredRequestsTable').DataTable({
        responsive: true,
        pageLength: 25,
        order: [[7, 'desc']], // Sort by created date
        columnDefs: [
            { orderable: false, targets: [8] } // Actions column
        ]
    });
}

function loadSellerRequests() {
    fetch('/api/admin/seller-requests/', {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        populateOfferRequests(data.offer_requests || []);
        populateFeaturedRequests(data.featured_requests || []);
        updateStatistics(data);
    })
    .catch(error => {
        console.error('Error loading seller requests:', error);
        showAlert('Failed to load seller requests', 'error');
    });
}

function populateOfferRequests(requests) {
    offerRequestsTable.clear();
    
    requests.forEach(request => {
        const row = [
            request.id,
            `<strong>${request.product_name}</strong>`,
            `${request.seller_name} (${request.seller_type})`,
            `${request.discount_percentage}%`,
            `<div class="text-center">
                <div>Original: ${request.original_price} EGP</div>
                <div class="text-success"><strong>Offer: ${request.offer_price} EGP</strong></div>
            </div>`,
            `<small>
                <div>Duration: ${request.offer_duration_days} days</div>
                ${request.start_date ? `<div>Start: ${formatDate(request.start_date)}</div>` : '<div>Start: Will be set on approval</div>'}
                ${request.end_date ? `<div>End: ${formatDate(request.end_date)}</div>` : '<div>End: Will be set on approval</div>'}
            </small>`,
            `${request.request_fee} EGP`,
            `<span class="badge status-${request.status.replace('_', '-')}">${request.status_display}</span>`,
            formatDate(request.created_at),
            generateOfferActions(request)
        ];
        offerRequestsTable.row.add(row);
    });
    
    offerRequestsTable.draw();
}

function populateFeaturedRequests(requests) {
    featuredRequestsTable.clear();
    
    requests.forEach(request => {
        const row = [
            request.id,
            `<strong>${request.product_name}</strong>`,
            `${request.seller_name} (${request.seller_type})`,
            `${request.featured_duration_days} days`,
            request.priority,
            `${request.request_fee} EGP`,
            `<span class="badge status-${request.status.replace('_', '-')}">${request.status_display}</span>`,
            formatDate(request.created_at),
            generateFeaturedActions(request)
        ];
        featuredRequestsTable.row.add(row);
    });
    
    featuredRequestsTable.draw();
}

function generateOfferActions(request) {
    let actions = `<button class="btn btn-sm btn-info me-1" onclick="viewRequestDetails('${request.id}', 'offer')" title="View Details">
        <i class="fas fa-eye"></i>
    </button>`;

    if (request.status === 'pending_payment') {
        actions += `<button class="btn btn-sm btn-success" onclick="showMarkPaymentModal('${request.id}', 'offer')" title="Mark Payment Completed">
            <i class="fas fa-credit-card"></i>
        </button>`;
    } else if (request.status === 'payment_completed') {
        actions += `<button class="btn btn-sm btn-warning" onclick="approveRequest('${request.id}', 'offer')" title="Approve Request">
            <i class="fas fa-check"></i>
        </button>`;
    }

    return actions;
}

function generateFeaturedActions(request) {
    let actions = `<button class="btn btn-sm btn-info me-1" onclick="viewRequestDetails('${request.id}', 'featured')" title="View Details">
        <i class="fas fa-eye"></i>
    </button>`;

    if (request.status === 'pending_payment') {
        actions += `<button class="btn btn-sm btn-success" onclick="showMarkPaymentModal('${request.id}', 'featured')" title="Mark Payment Completed">
            <i class="fas fa-credit-card"></i>
        </button>`;
    } else if (request.status === 'payment_completed') {
        actions += `<button class="btn btn-sm btn-warning" onclick="approveRequest('${request.id}', 'featured')" title="Approve Request">
            <i class="fas fa-check"></i>
        </button>`;
    }

    return actions;
}

function showMarkPaymentModal(requestId, requestType) {
    currentRequestId = requestId;
    currentRequestType = requestType;
    $('#markPaymentModal').modal('show');
}

function markPaymentCompleted() {
    const paymentReference = $('#paymentReference').val();
    const adminNotes = $('#adminNotes').val();
    
    if (!paymentReference.trim()) {
        showAlert('Please enter a payment reference', 'error');
        return;
    }
    
    // API call to mark payment completed and auto-approve
    fetch(`/api/admin/seller-requests/${currentRequestId}/mark-payment-and-approve/`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            request_type: currentRequestType,
            payment_reference: paymentReference,
            admin_notes: adminNotes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showAlert(data.message, 'success');
            $('#markPaymentModal').modal('hide');
            loadSellerRequests();
        } else {
            let errorMessage = data.error || 'Failed to process payment';
            let alertType = 'error';
            
            // Handle already approved requests differently
            if (data.status === 'already_approved') {
                alertType = 'warning';
                errorMessage = data.error + ' Please refresh the page to see current status.';
            }
            
            showAlert(errorMessage, alertType);
        }
    })
    .catch(error => {
        console.error('Error processing payment:', error);
        showAlert('Failed to process payment', 'error');
    });
}

function approveRequest(requestId, requestType) {
    if (!confirm(`Are you sure you want to approve this ${requestType} request?`)) {
        return;
    }

    const endpoint = requestType === 'offer' ? 
        `/api/admin/seller-requests/offer/${requestId}/approve/` :
        `/api/admin/seller-requests/featured/${requestId}/approve/`;

    fetch(endpoint, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showAlert(data.message, 'success');
            loadSellerRequests();
        } else {
            showAlert(data.error || 'Failed to approve request', 'error');
        }
    })
    .catch(error => {
        console.error('Error approving request:', error);
        showAlert('Failed to approve request', 'error');
    });
}

function updateStatistics(data) {
    const totalOfferRequests = data.total_offer_requests || 0;
    const totalFeaturedRequests = data.total_featured_requests || 0;
    
    $('#totalOfferRequests').text(totalOfferRequests);
    $('#totalFeaturedRequests').text(totalFeaturedRequests);
    
    // Calculate pending requests
    const pendingOffers = (data.offer_requests || []).filter(r => r.status === 'payment_completed').length;
    const pendingFeatured = (data.featured_requests || []).filter(r => r.status === 'payment_completed').length;
    $('#pendingRequests').text(pendingOffers + pendingFeatured);
    
    // Calculate total revenue (this is a simplified calculation)
    const totalRevenue = ((data.offer_requests || []).length * 50) + ((data.featured_requests || []).length * 100);
    $('#totalRevenue').text(totalRevenue + ' EGP');
}

function refreshRequests() {
    loadSellerRequests();
    showAlert('Requests refreshed successfully!', 'success');
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function getCSRFToken() {
    // Try multiple ways to get CSRF token
    let token = document.querySelector('[name=csrfmiddlewaretoken]');
    if (token) return token.value;
    
    token = document.querySelector('meta[name=csrf-token]');
    if (token) return token.getAttribute('content');
    
    // Get from cookie
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') return value;
    }
    
    return '';
}

function showAlert(message, type = 'info') {
    const alertClass = type === 'error' ? 'alert-danger' : `alert-${type}`;
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    
    // Remove existing alerts
    $('.alert').remove();
    
    // Add new alert at the top of the container
    $('.container-fluid').prepend(alertHtml);
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        $('.alert').fadeOut();
    }, 5000);
}
</script>
{% endblock %}