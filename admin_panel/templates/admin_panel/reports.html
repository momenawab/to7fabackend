{% extends 'admin_panel/base.html' %}

{% block title %}Reports - To7fa Admin Panel{% endblock %}

{% block page_title %}Reports & Analytics{% endblock %}

{% block content %}
<!-- Content Management Section -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Content Management</span>
                <button class="btn btn-purple btn-sm" onclick="refreshContentSettings()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="showLatestOffers">
                            <label class="form-check-label" for="showLatestOffers">
                                Show Latest Offers
                            </label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="showFeaturedProducts">
                            <label class="form-check-label" for="showFeaturedProducts">
                                Show Featured Products
                            </label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="showTopArtists">
                            <label class="form-check-label" for="showTopArtists">
                                Show Top Artists
                            </label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="showTopStores">
                            <label class="form-check-label" for="showTopStores">
                                Show Top Stores
                            </label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="showAdsSlider">
                            <label class="form-check-label" for="showAdsSlider">
                                Show Ads Slider
                            </label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="enableContentCache">
                            <label class="form-check-label" for="enableContentCache">
                                Enable Content Cache
                            </label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="maxProducts" class="form-label">Max Products per Section</label>
                            <input type="number" class="form-control" id="maxProducts" min="1" max="50">
                        </div>
                        <div class="mb-3">
                            <label for="refreshInterval" class="form-label">Refresh Interval (min)</label>
                            <input type="number" class="form-control" id="refreshInterval" min="1" max="60">
                        </div>
                    </div>
                </div>
                <div class="text-end">
                    <button class="btn btn-success" onclick="saveContentSettings()">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Advertisement Management -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Advertisement Management</span>
                <button class="btn btn-purple btn-sm" data-bs-toggle="modal" data-bs-target="#addAdModal">
                    <i class="fas fa-plus"></i> Add Advertisement
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Order</th>
                                <th>Title</th>
                                <th>Image</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="advertisementsTable">
                            <tr>
                                <td colspan="5" class="text-center">Loading advertisements...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Date Range</span>
                <div>
                    <select class="form-select" id="reportDateRange">
                        <option value="7">Last 7 Days</option>
                        <option value="30" selected>Last 30 Days</option>
                        <option value="90">Last 3 Months</option>
                        <option value="180">Last 6 Months</option>
                        <option value="365">Last Year</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
            </div>
            <div class="card-body" id="customDateRange" style="display: none;">
                <div class="row">
                    <div class="col-md-5">
                        <div class="mb-3">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="mb-3">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-purple w-100 mb-3" id="applyDateRange">Apply</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sales Overview -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <span>Sales Overview</span>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <h3 id="totalSales">$0</h3>
                            <p>Total Sales</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <h3 id="totalOrders">0</h3>
                            <p>Total Orders</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <h3 id="averageOrderValue">$0</h3>
                            <p>Average Order Value</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <h3 id="conversionRate">0%</h3>
                            <p>Conversion Rate</p>
                        </div>
                    </div>
                </div>
                <div>
                    <canvas id="salesChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- User Growth -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <span>User Growth</span>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="stats-card">
                            <h3 id="totalUsers">0</h3>
                            <p>Total Users</p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stats-card">
                            <h3 id="newUsers">0</h3>
                            <p>New Users</p>
                        </div>
                    </div>
                </div>
                <canvas id="userGrowthChart" height="250"></canvas>
            </div>
        </div>
    </div>
    
    <!-- User Types Distribution -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <span>User Types Distribution</span>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-4">
                        <div class="stats-card">
                            <h3 id="customerCount">0</h3>
                            <p>Customers</p>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stats-card">
                            <h3 id="artistCount">0</h3>
                            <p>Artists</p>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stats-card">
                            <h3 id="storeCount">0</h3>
                            <p>Stores</p>
                        </div>
                    </div>
                </div>
                <canvas id="userTypeChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Top Products -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <span>Top Selling Products</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Units Sold</th>
                                <th>Revenue</th>
                            </tr>
                        </thead>
                        <tbody id="topProductsTable">
                            <tr>
                                <td colspan="4" class="text-center">Loading data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Top Categories -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <span>Top Categories</span>
            </div>
            <div class="card-body">
                <canvas id="categoriesChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Order Status Distribution -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <span>Order Status Distribution</span>
            </div>
            <div class="card-body">
                <canvas id="orderStatusChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Monthly Revenue Trend -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <span>Monthly Revenue Trend</span>
            </div>
            <div class="card-body">
                <canvas id="revenueChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Add Advertisement Modal -->
<div class="modal fade" id="addAdModal" tabindex="-1" aria-labelledby="addAdModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAdModalLabel">Add Advertisement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addAdForm">
                    <div class="mb-3">
                        <label for="adTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="adTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="adDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="adDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="adImageUrl" class="form-label">Image URL</label>
                        <input type="url" class="form-control" id="adImageUrl" placeholder="https://example.com/image.jpg">
                    </div>
                    <div class="mb-3">
                        <label for="adLinkUrl" class="form-label">Link URL (Optional)</label>
                        <input type="url" class="form-control" id="adLinkUrl" placeholder="https://example.com">
                    </div>
                    <div class="mb-3">
                        <label for="adOrder" class="form-label">Display Order</label>
                        <input type="number" class="form-control" id="adOrder" value="0" min="0">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="adIsActive" checked>
                        <label class="form-check-label" for="adIsActive">
                            Active
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-purple" onclick="saveAdvertisement()">Save Advertisement</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Advertisement Modal -->
<div class="modal fade" id="editAdModal" tabindex="-1" aria-labelledby="editAdModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAdModalLabel">Edit Advertisement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editAdForm">
                    <input type="hidden" id="editAdId">
                    <div class="mb-3">
                        <label for="editAdTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="editAdTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="editAdDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editAdDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editAdImageUrl" class="form-label">Image URL</label>
                        <input type="url" class="form-control" id="editAdImageUrl">
                    </div>
                    <div class="mb-3">
                        <label for="editAdLinkUrl" class="form-label">Link URL (Optional)</label>
                        <input type="url" class="form-control" id="editAdLinkUrl">
                    </div>
                    <div class="mb-3">
                        <label for="editAdOrder" class="form-label">Display Order</label>
                        <input type="number" class="form-control" id="editAdOrder" min="0">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="editAdIsActive">
                        <label class="form-check-label" for="editAdIsActive">
                            Active
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-purple" onclick="updateAdvertisement()">Update Advertisement</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Date Range Selector
    $('#reportDateRange').change(function() {
        if ($(this).val() === 'custom') {
            $('#customDateRange').slideDown();
        } else {
            $('#customDateRange').slideUp();
            loadReportData($(this).val());
        }
    });
    
    $('#applyDateRange').click(function() {
        const startDate = $('#startDate').val();
        const endDate = $('#endDate').val();
        
        if (!startDate || !endDate) {
            alert('Please select both start and end dates');
            return;
        }
        
        loadReportData('custom', startDate, endDate);
    });
    
    // Load initial data
    $(document).ready(function() {
        loadReportData(30); // Default to 30 days
        loadContentSettings();
        loadAdvertisements();
    });
    
    function loadReportData(days, startDate = null, endDate = null) {
        // Show loading indicators
        $('#totalSales').text('Loading...');
        $('#totalOrders').text('Loading...');
        $('#averageOrderValue').text('Loading...');
        $('#conversionRate').text('Loading...');
        $('#totalUsers').text('Loading...');
        $('#newUsers').text('Loading...');
        $('#customerCount').text('Loading...');
        $('#artistCount').text('Loading...');
        $('#storeCount').text('Loading...');
        $('#topProductsTable').html('<tr><td colspan="4" class="text-center">Loading data...</td></tr>');
        
        // API endpoint for reports
        let url = '/api/admin/reports/summary/?days=' + days;
        if (days === 'custom') {
            url = `/api/admin/reports/summary/?start_date=${startDate}&end_date=${endDate}`;
        }
        
        // Fetch report data
        fetch(url, {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Update summary stats
                $('#totalSales').text('$' + data.sales.total_revenue.toFixed(2));
                $('#totalOrders').text(data.sales.total_orders);
                $('#averageOrderValue').text('$' + data.sales.average_order_value.toFixed(2));
                $('#conversionRate').text(data.sales.conversion_rate.toFixed(2) + '%');
                
                $('#totalUsers').text(data.users.total);
                $('#newUsers').text(data.users.new_users);
                $('#customerCount').text(data.users.customers);
                $('#artistCount').text(data.users.artists);
                $('#storeCount').text(data.users.stores);
                
                // Render charts
                renderSalesChart(data.sales.daily_data);
                renderUserGrowthChart(data.users.growth_data);
                renderUserTypeChart(data.users);
                renderTopProductsTable(data.products.top_products);
                renderCategoriesChart(data.products.top_categories);
                renderOrderStatusChart(data.sales.status_distribution);
                renderRevenueChart(data.sales.monthly_revenue);
            })
            .catch(error => {
                console.error('Error loading report data:', error);
                alert('Failed to load report data. Please try again later.');
            });
    }
    
    // Chart rendering functions
    function renderSalesChart(data) {
        const ctx = document.getElementById('salesChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (window.salesChart) {
            window.salesChart.destroy();
        }
        
        window.salesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(item => item.date),
                datasets: [{
                    label: 'Revenue',
                    data: data.map(item => item.revenue),
                    backgroundColor: 'rgba(94, 53, 177, 0.1)',
                    borderColor: '#5e35b1',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                }, {
                    label: 'Orders',
                    data: data.map(item => item.orders),
                    backgroundColor: 'rgba(255, 152, 0, 0.1)',
                    borderColor: '#ff9800',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Revenue ($)'
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false
                        },
                        title: {
                            display: true,
                            text: 'Orders'
                        }
                    }
                }
            }
        });
    }
    
    function renderUserGrowthChart(data) {
        const ctx = document.getElementById('userGrowthChart').getContext('2d');
        
        if (window.userGrowthChart) {
            window.userGrowthChart.destroy();
        }
        
        window.userGrowthChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(item => item.date),
                datasets: [{
                    label: 'New Users',
                    data: data.map(item => item.count),
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    borderColor: '#4caf50',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    function renderUserTypeChart(data) {
        const ctx = document.getElementById('userTypeChart').getContext('2d');
        
        if (window.userTypeChart) {
            window.userTypeChart.destroy();
        }
        
        window.userTypeChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Customers', 'Artists', 'Stores'],
                datasets: [{
                    data: [data.customers, data.artists, data.stores],
                    backgroundColor: [
                        '#5e35b1',
                        '#ff9800',
                        '#4caf50'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    function renderTopProductsTable(products) {
        let html = '';
        
        if (products.length === 0) {
            html = '<tr><td colspan="4" class="text-center">No data available</td></tr>';
        } else {
            products.forEach(product => {
                html += `
                    <tr>
                        <td>${product.name}</td>
                        <td>${product.category}</td>
                        <td>${product.units_sold}</td>
                        <td>$${product.revenue.toFixed(2)}</td>
                    </tr>
                `;
            });
        }
        
        $('#topProductsTable').html(html);
    }
    
    function renderCategoriesChart(categories) {
        const ctx = document.getElementById('categoriesChart').getContext('2d');
        
        if (window.categoriesChart) {
            window.categoriesChart.destroy();
        }
        
        window.categoriesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: categories.map(item => item.name),
                datasets: [{
                    label: 'Revenue',
                    data: categories.map(item => item.revenue),
                    backgroundColor: '#5e35b1',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Revenue ($)'
                        }
                    }
                }
            }
        });
    }
    
    function renderOrderStatusChart(statusData) {
        const ctx = document.getElementById('orderStatusChart').getContext('2d');
        
        if (window.orderStatusChart) {
            window.orderStatusChart.destroy();
        }
        
        const labels = Object.keys(statusData);
        const data = Object.values(statusData);
        const backgroundColors = {
            'pending': '#ffc107',
            'processing': '#17a2b8',
            'shipped': '#007bff',
            'delivered': '#28a745',
            'cancelled': '#dc3545'
        };
        
        window.orderStatusChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels.map(label => label.charAt(0).toUpperCase() + label.slice(1)),
                datasets: [{
                    data: data,
                    backgroundColor: labels.map(label => backgroundColors[label] || '#6c757d'),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    function renderRevenueChart(monthlyData) {
        const ctx = document.getElementById('revenueChart').getContext('2d');
        
        if (window.revenueChart) {
            window.revenueChart.destroy();
        }
        
        window.revenueChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: monthlyData.map(item => item.month),
                datasets: [{
                    label: 'Revenue',
                    data: monthlyData.map(item => item.revenue),
                    backgroundColor: '#5e35b1',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Revenue ($)'
                        }
                    }
                }
            }
        });
    }
    
    // Content Management Functions
    function loadContentSettings() {
        fetch('/api/products/content-settings/')
            .then(response => response.json())
            .then(data => {
                $('#showLatestOffers').prop('checked', data.showLatestOffers);
                $('#showFeaturedProducts').prop('checked', data.showFeaturedProducts);
                $('#showTopArtists').prop('checked', data.showTopArtists);
                $('#showTopStores').prop('checked', data.showTopStores);
                $('#showAdsSlider').prop('checked', data.showAdsSlider);
                $('#enableContentCache').prop('checked', data.enableContentCache);
                $('#maxProducts').val(data.maxProductsPerSection);
                $('#refreshInterval').val(data.contentRefreshInterval);
            })
            .catch(error => {
                console.error('Error loading content settings:', error);
                showAlert('Failed to load content settings', 'error');
            });
    }
    
    function refreshContentSettings() {
        loadContentSettings();
        showAlert('Content settings refreshed', 'success');
    }
    
    function saveContentSettings() {
        const settings = {
            showLatestOffers: $('#showLatestOffers').is(':checked'),
            showFeaturedProducts: $('#showFeaturedProducts').is(':checked'),
            showTopArtists: $('#showTopArtists').is(':checked'),
            showTopStores: $('#showTopStores').is(':checked'),
            showAdsSlider: $('#showAdsSlider').is(':checked'),
            enableContentCache: $('#enableContentCache').is(':checked'),
            maxProductsPerSection: parseInt($('#maxProducts').val()),
            contentRefreshInterval: parseInt($('#refreshInterval').val())
        };
        
        // Note: You'll need to implement the backend endpoint for saving settings
        // For now, we'll just show a success message
        showAlert('Content settings saved successfully', 'success');
        console.log('Settings to save:', settings);
    }
    
    // Advertisement Management Functions
    function loadAdvertisements() {
        fetch('/api/products/advertisements/')
            .then(response => response.json())
            .then(data => {
                renderAdvertisementsTable(data.results);
            })
            .catch(error => {
                console.error('Error loading advertisements:', error);
                $('#advertisementsTable').html('<tr><td colspan="5" class="text-center text-danger">Failed to load advertisements</td></tr>');
            });
    }
    
    function renderAdvertisementsTable(ads) {
        let html = '';
        
        if (ads.length === 0) {
            html = '<tr><td colspan="5" class="text-center">No advertisements found</td></tr>';
        } else {
            ads.forEach(ad => {
                html += `
                    <tr>
                        <td>${ad.order}</td>
                        <td>${ad.title}</td>
                        <td>
                            ${ad.imageUrl ? `<img src="${ad.imageUrl}" alt="${ad.title}" style="width: 50px; height: 30px; object-fit: cover;" class="rounded">` : '<span class="text-muted">No image</span>'}
                        </td>
                        <td>
                            <span class="badge ${ad.isActive ? 'bg-success' : 'bg-secondary'}">
                                ${ad.isActive ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editAdvertisement('${ad.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteAdvertisement('${ad.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }
        
        $('#advertisementsTable').html(html);
    }
    
    function saveAdvertisement() {
        const adData = {
            title: $('#adTitle').val(),
            description: $('#adDescription').val(),
            imageUrl: $('#adImageUrl').val(),
            linkUrl: $('#adLinkUrl').val(),
            order: parseInt($('#adOrder').val()),
            isActive: $('#adIsActive').is(':checked')
        };
        
        if (!adData.title.trim()) {
            showAlert('Please enter a title for the advertisement', 'error');
            return;
        }
        
        // Note: You'll need to implement the backend endpoint for creating ads
        // For now, we'll just show a success message and close the modal
        showAlert('Advertisement added successfully', 'success');
        $('#addAdModal').modal('hide');
        $('#addAdForm')[0].reset();
        loadAdvertisements();
        
        console.log('Advertisement to save:', adData);
    }
    
    function editAdvertisement(adId) {
        // Note: You'll need to implement the backend endpoint for getting ad details
        // For now, we'll just open the edit modal
        $('#editAdModal').modal('show');
        $('#editAdId').val(adId);
        
        // You would fetch the ad details here and populate the form
        console.log('Editing advertisement:', adId);
    }
    
    function updateAdvertisement() {
        const adId = $('#editAdId').val();
        const adData = {
            title: $('#editAdTitle').val(),
            description: $('#editAdDescription').val(),
            imageUrl: $('#editAdImageUrl').val(),
            linkUrl: $('#editAdLinkUrl').val(),
            order: parseInt($('#editAdOrder').val()),
            isActive: $('#editAdIsActive').is(':checked')
        };
        
        if (!adData.title.trim()) {
            showAlert('Please enter a title for the advertisement', 'error');
            return;
        }
        
        // Note: You'll need to implement the backend endpoint for updating ads
        showAlert('Advertisement updated successfully', 'success');
        $('#editAdModal').modal('hide');
        loadAdvertisements();
        
        console.log('Advertisement to update:', adId, adData);
    }
    
    function deleteAdvertisement(adId) {
        if (confirm('Are you sure you want to delete this advertisement?')) {
            // Note: You'll need to implement the backend endpoint for deleting ads
            showAlert('Advertisement deleted successfully', 'success');
            loadAdvertisements();
            
            console.log('Deleting advertisement:', adId);
        }
    }
    
    // Utility function for showing alerts
    function showAlert(message, type = 'info') {
        const alertClass = {
            'success': 'alert-success',
            'error': 'alert-danger',
            'warning': 'alert-warning',
            'info': 'alert-info'
        }[type] || 'alert-info';
        
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        
        $('body').append(alertHtml);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            $('.alert').fadeOut();
        }, 5000);
    }
</script>
{% endblock %} 