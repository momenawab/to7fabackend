{% extends 'admin_panel/base.html' %}

{% block title %}Notifications Management - To7fa Admin Panel{% endblock %}

{% block page_title %}Notifications Management{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css">
<style>
    .notification-card {
        border: 1px solid var(--border-light);
        border-radius: var(--radius);
        background: var(--white);
        transition: var(--transition);
    }
    
    .notification-card:hover {
        box-shadow: var(--shadow);
        border-color: var(--primary);
    }
    
    .notification-item {
        padding: 1rem;
        border-bottom: 1px solid var(--border-light);
    }
    
    .notification-item:last-child {
        border-bottom: none;
    }
    
    .notification-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 1rem;
        font-weight: 500;
    }
    
    .badge-sale { background: #FEF3C7; color: #D97706; }
    .badge-order { background: #D1FAE5; color: #059669; }
    .badge-ticket { background: #DDD6FE; color: #7C3AED; }
    .badge-app { background: #DBEAFE; color: #2563EB; }
    .badge-product { background: #FCE7F3; color: #DB2777; }
    
    .stat-card {
        background: var(--white);
        border: 1px solid var(--border-light);
        border-radius: var(--radius);
        padding: 1.5rem;
        text-align: center;
        transition: var(--transition);
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: var(--text-secondary);
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .chart-container {
        background: var(--white);
        border: 1px solid var(--border-light);
        border-radius: var(--radius);
        padding: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number">{{ total_notifications }}</div>
                <div class="stat-label">Total Notifications</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number">{{ unread_count }}</div>
                <div class="stat-label">Unread</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number">{{ today_count }}</div>
                <div class="stat-label">Today</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number">{{ bulk_notifications|length }}</div>
                <div class="stat-label">Bulk Notifications</div>
            </div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h4>Notifications Dashboard</h4>
                <div>
                    <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#pushNotificationModal">
                        <i class="fas fa-mobile-alt"></i> Send Push Notification
                    </button>
                    <a href="{% url 'admin_panel:bulk_notifications' %}" class="btn btn-primary me-2">
                        <i class="fas fa-plus"></i> New Bulk Notification
                    </a>
                    <a href="{% url 'admin_panel:notification_users' %}" class="btn btn-outline-primary me-2">
                        <i class="fas fa-users"></i> Manage Users
                    </a>
                    <button class="btn btn-outline-secondary" onclick="refreshStats()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Type Distribution Chart -->
        <div class="col-md-6 mb-4">
            <div class="chart-container">
                <h5 class="mb-3">Notification Distribution by Type</h5>
                {% if type_stats %}
                <canvas id="typeChart" width="400" height="300"></canvas>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No statistics available</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Recent Bulk Notifications -->
        <div class="col-md-6 mb-4">
            <div class="notification-card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Recent Bulk Notifications</h5>
                </div>
                <div class="card-body p-0">
                    {% if bulk_notifications %}
                        {% for bulk in bulk_notifications %}
                        <div class="notification-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ bulk.title }}</h6>
                                    <p class="text-muted small mb-2">{{ bulk.message|truncatechars:100 }}</p>
                                    <div class="d-flex align-items-center">
                                        <span class="notification-badge badge-{{ bulk.notification_type }}">
                                            {{ bulk.get_notification_type_display }}
                                        </span>
                                        <span class="text-muted small ms-2">
                                            {{ bulk.target_audience }} • {{ bulk.recipient_count }} users
                                        </span>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">{{ bulk.created_at|timesince }}</small>
                                    <div class="mt-1">
                                        {% if bulk.is_sent %}
                                        <span class="badge bg-success">Sent</span>
                                        {% else %}
                                        <span class="badge bg-warning">Pending</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No bulk notifications</p>
                        <a href="{% url 'admin_panel:bulk_notifications' %}" class="btn btn-primary">
                            Create First Notification
                        </a>
                    </div>
                    {% endif %}
                </div>
                {% if bulk_notifications %}
                <div class="card-footer bg-white text-center">
                    <a href="{% url 'admin_panel:bulk_notifications' %}" class="text-primary">
                        View All Bulk Notifications
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Recent Individual Notifications -->
    <div class="row">
        <div class="col-12">
            <div class="notification-card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Recent Individual Notifications</h5>
                </div>
                <div class="card-body p-0">
                    {% if recent_notifications %}
                        {% for notification in recent_notifications %}
                        <div class="notification-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-2">
                                        <h6 class="mb-0 me-2">{{ notification.title }}</h6>
                                        <span class="notification-badge badge-{{ notification.notification_type }}">
                                            {{ notification.get_notification_type_display }}
                                        </span>
                                        {% if notification.priority == 'urgent' %}
                                        <span class="badge bg-danger ms-1">Urgent</span>
                                        {% elif notification.priority == 'high' %}
                                        <span class="badge bg-warning ms-1">High</span>
                                        {% endif %}
                                    </div>
                                    <p class="text-muted small mb-2">{{ notification.message|truncatechars:150 }}</p>
                                    <div class="d-flex align-items-center">
                                        <span class="text-muted small">
                                            <i class="fas fa-user"></i> {{ notification.user.email|truncatechars:30 }}
                                        </span>
                                        {% if notification.action_url %}
                                        <span class="text-muted small ms-3">
                                            <i class="fas fa-link"></i> Contains link
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">{{ notification.created_at|timesince }}</small>
                                    <div class="mt-1">
                                        {% if notification.is_read %}
                                        <span class="badge bg-success">Read</span>
                                        {% else %}
                                        <span class="badge bg-primary">New</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No individual notifications</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Push Notification Modal -->
    <div class="modal fade" id="pushNotificationModal" tabindex="-1" aria-labelledby="pushNotificationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pushNotificationModalLabel">Send Push Notification</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="pushNotificationForm">
                        {% csrf_token %}
                        <ul class="nav nav-tabs mb-3" id="notificationTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="single-tab" data-bs-toggle="tab" data-bs-target="#single" type="button" role="tab" aria-controls="single" aria-selected="true">Single Notification</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="bulk-tab" data-bs-toggle="tab" data-bs-target="#bulk" type="button" role="tab" aria-controls="bulk" aria-selected="false">Bulk Notification</button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="notificationTabContent">
                            <!-- Single Notification Tab -->
                            <div class="tab-pane fade show active" id="single" role="tabpanel" aria-labelledby="single-tab">
                                <div class="mb-3">
                                    <label for="singleUserEmail" class="form-label">User Email</label>
                                    <input type="email" class="form-control" id="singleUserEmail" name="user_email" placeholder="user@example.com" required>
                                    <div class="form-text">Enter the email of the user to send the notification to</div>
                                </div>
                            </div>
                            
                            <!-- Bulk Notification Tab -->
                            <div class="tab-pane fade" id="bulk" role="tabpanel" aria-labelledby="bulk-tab">
                                <div class="mb-3">
                                    <label for="targetAudience" class="form-label">Target Audience</label>
                                    <select class="form-control" id="targetAudience" name="target_audience">
                                        <option value="all">All Users</option>
                                        <option value="active">Active Users</option>
                                        <option value="sellers">Sellers</option>
                                        <option value="customers">Customers</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Common Fields -->
                        <div class="mb-3">
                            <label for="notificationTitle" class="form-label">Notification Title</label>
                            <input type="text" class="form-control" id="notificationTitle" name="title" placeholder="Enter notification title" required maxlength="100">
                        </div>
                        
                        <div class="mb-3">
                            <label for="notificationMessage" class="form-label">Notification Message</label>
                            <textarea class="form-control" id="notificationMessage" name="message" rows="4" placeholder="Enter notification message" required maxlength="500"></textarea>
                            <div class="form-text">Maximum: 500 characters</div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="notificationType" class="form-label">Notification Type</label>
                                    <select class="form-control" id="notificationType" name="notification_type" required>
                                        <option value="app">App</option>
                                        <option value="order">Order</option>
                                        <option value="product">Product</option>
                                        <option value="sale">Sale</option>
                                        <option value="ticket">Support Ticket</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="notificationPriority" class="form-label">Priority</label>
                                    <select class="form-control" id="notificationPriority" name="priority">
                                        <option value="normal">Normal</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="actionUrl" class="form-label">Action URL (Optional)</label>
                                    <input type="url" class="form-control" id="actionUrl" name="action_url" placeholder="https://example.com">
                                    <div class="form-text">Link that opens when notification is tapped</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="imageUrl" class="form-label">Image URL (Optional)</label>
                                    <input type="url" class="form-control" id="imageUrl" name="image_url" placeholder="https://example.com/image.jpg">
                                    <div class="form-text">Notification image</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sendPush" name="send_push" checked>
                                <label class="form-check-label" for="sendPush">
                                    Send Push Notification
                                </label>
                                <div class="form-text">Notification will appear in the top status bar of the device</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="sendNotificationBtn">
                        <i class="fas fa-paper-plane"></i> Send Notification
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    // Type Distribution Chart
    {% if type_stats %}
    const typeCtx = document.getElementById('typeChart').getContext('2d');
    const typeChart = new Chart(typeCtx, {
        type: 'doughnut',
        data: {
            labels: [
                {% for type, stats in type_stats.items %}
                '{{ stats.display }}'{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            datasets: [{
                data: [
                    {% for type, stats in type_stats.items %}
                    {{ stats.count }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                backgroundColor: [
                    '#F59E0B', '#10B981', '#8B5CF6', '#3B82F6', '#EC4899',
                    '#6B7280', '#EF4444', '#F97316'
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: {
                            size: 12
                        }
                    }
                }
            }
        }
    });
    {% endif %}
    
    // Refresh Stats Function
    function refreshStats() {
        const refreshBtn = document.querySelector('button[onclick="refreshStats()"]');
        const icon = refreshBtn.querySelector('i');
        
        icon.classList.add('fa-spin');
        refreshBtn.disabled = true;
        
        fetch('{% url "admin_panel:notification_stats" %}')
            .then(response => response.json())
            .then(data => {
                // Update stats cards
                document.querySelector('.stat-number').textContent = data.stats.total;
                
                // Re-enable button
                setTimeout(() => {
                    icon.classList.remove('fa-spin');
                    refreshBtn.disabled = false;
                    location.reload(); // Refresh the page to show updated data
                }, 1000);
            })
            .catch(error => {
                console.error('Error refreshing stats:', error);
                icon.classList.remove('fa-spin');
                refreshBtn.disabled = false;
                alert('Error occurred while refreshing statistics');
            });
    }
    
    // Auto-refresh every 30 seconds
    setInterval(refreshStats, 30000);
    
    // Push Notification Form Handler
    document.getElementById('sendNotificationBtn').addEventListener('click', function() {
        const form = document.getElementById('pushNotificationForm');
        const formData = new FormData(form);
        const activeTab = document.querySelector('.nav-link.active').getAttribute('aria-controls');
        const sendBtn = this;
        
        // Validate required fields
        const title = formData.get('title');
        const message = formData.get('message');
        const notificationType = formData.get('notification_type');
        
        if (!title || !message || !notificationType) {
            alert('Please fill in all required fields');
            return;
        }
        
        // Validate user email for single notification
        if (activeTab === 'single') {
            const userEmail = formData.get('user_email');
            if (!userEmail || !userEmail.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }
        }
        
        // Disable button and show loading
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
        
        // Prepare data based on tab type
        let apiUrl, requestData;
        
        if (activeTab === 'single') {
            apiUrl = '{% url "admin_api:send_user_notification" %}';
            requestData = {
                user_email: formData.get('user_email'),
                title: title,
                message: message,
                notification_type: notificationType,
                priority: formData.get('priority') || 'normal',
                action_url: formData.get('action_url') || '',
                image_url: formData.get('image_url') || '',
                send_push: formData.get('send_push') === 'on'
            };
        } else {
            apiUrl = '{% url "admin_api:send_bulk_notification" %}';
            requestData = {
                target_audience: formData.get('target_audience'),
                title: title,
                message: message,
                notification_type: notificationType,
                priority: formData.get('priority') || 'normal',
                action_url: formData.get('action_url') || '',
                image_url: formData.get('image_url') || '',
                send_push: formData.get('send_push') === 'on'
            };
        }
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Send request
        fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Success
                alert('✅ ' + data.message);
                
                // Close modal and reset form
                const modal = bootstrap.Modal.getInstance(document.getElementById('pushNotificationModal'));
                modal.hide();
                form.reset();
                
                // Refresh the page to show updated notifications
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                // Error
                alert('❌ Error: ' + (data.message || data.error || 'An unexpected error occurred'));
            }
        })
        .catch(error => {
            console.error('Error sending notification:', error);
            alert('❌ Connection error occurred');
        })
        .finally(() => {
            // Re-enable button
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Notification';
        });
    });
    
    // Character counter for message field
    document.getElementById('notificationMessage').addEventListener('input', function() {
        const maxLength = 500;
        const currentLength = this.value.length;
        const remaining = maxLength - currentLength;
        
        let counter = document.getElementById('messageCounter');
        if (!counter) {
            counter = document.createElement('small');
            counter.id = 'messageCounter';
            counter.className = 'form-text';
            this.parentNode.appendChild(counter);
        }
        
        counter.textContent = `${remaining} characters remaining`;
        counter.style.color = remaining < 50 ? '#dc3545' : '#6c757d';
    });
    
    // Tab change handler to reset validation
    document.querySelectorAll('#notificationTabs button[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function() {
            // Clear any validation errors when switching tabs
            document.querySelectorAll('.is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
        });
    });
</script>
{% endblock %}