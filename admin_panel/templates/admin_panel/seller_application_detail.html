{% extends 'admin_panel/base.html' %}

{% block title %}Application Details - To7fa Admin Panel{% endblock %}

{% block page_title %}Seller Application Details{% endblock %}

{% block extra_css %}
<style>
    .info-card {
        border-left: 4px solid #6f42c1;
        background: #f8f9fa;
    }
    .shipping-available {
        color: #28a745;
        font-weight: bold;
    }
    .shipping-unavailable {
        color: #dc3545;
        text-decoration: line-through;
    }
    .badge-category {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .badge-subcategory {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .id-document {
        max-width: 300px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        transition: transform 0.2s;
    }
    .id-document:hover {
        transform: scale(1.05);
        border-color: #6f42c1;
    }
    .social-link {
        display: inline-block;
        margin: 5px 10px 5px 0;
        padding: 8px 15px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        text-decoration: none;
        color: #6f42c1;
        transition: all 0.2s;
    }
    .social-link:hover {
        background: #6f42c1;
        color: white;
        text-decoration: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <!-- Application Status Card -->
        <div class="card mb-4 info-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><strong>Application #{{ application.id }}</strong></span>
                <div>
                    {% if application.status == 'pending' %}
                    <span class="badge bg-warning text-dark">‚è≥ Pending Review</span>
                    {% elif application.status == 'approved' %}
                    <span class="badge bg-success">‚úÖ Approved</span>
                    {% elif application.status == 'rejected' %}
                    <span class="badge bg-danger">‚ùå Rejected</span>
                    {% elif application.status == 'rejected_permanently' %}
                    <span class="badge bg-dark">üö´ Permanently Rejected</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted">üìÖ SUBMITTED</h6>
                        <p class="mb-2">{{ application.submitted_at|date:"F d, Y H:i" }}</p>
                    </div>
                    {% if application.processed_at %}
                    <div class="col-md-6">
                        <h6 class="text-muted">‚ö° PROCESSED</h6>
                        <p class="mb-2">{{ application.processed_at|date:"F d, Y H:i" }}</p>
                        <small class="text-muted">by {{ application.processed_by.email }}</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Basic Information Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">üë§ Basic Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th style="width: 120px;">Name:</th>
                                <td><strong>{{ application.name }}</strong></td>
                            </tr>
                            <tr>
                                <th>Email:</th>
                                <td>{{ application.email }}</td>
                            </tr>
                            <tr>
                                <th>Phone:</th>
                                <td>{{ application.phone_number }}</td>
                            </tr>
                            <tr>
                                <th>Type:</th>
                                <td>
                                    {% if application.user_type == 'artist' %}
                                    <span class="badge bg-primary">üé® Artist</span>
                                    {% else %}
                                    <span class="badge bg-info">üè™ Store</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th style="width: 120px;">Address:</th>
                                <td>{{ application.address }}</td>
                            </tr>
                            {% if application.bio %}
                            <tr>
                                <th>Bio:</th>
                                <td>{{ application.bio }}</td>
                            </tr>
                            {% endif %}
                            {% if application.terms_accepted_at %}
                            <tr>
                                <th>Terms Accepted:</th>
                                <td>{{ application.terms_accepted_at|date:"F d, Y H:i" }}</td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Type Specific Information -->
        {% if application.user_type == 'artist' %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">üé® Artist Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <th style="width: 120px;">Specialty:</th>
                        <td><span class="badge bg-primary">{{ application.specialty }}</span></td>
                    </tr>
                    {% if application.bio %}
                    <tr>
                        <th>Bio:</th>
                        <td>{{ application.bio }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
        {% elif application.user_type == 'store' %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">üè™ Store Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <th style="width: 150px;">Store Name:</th>
                        <td><strong>{{ application.store_name }}</strong></td>
                    </tr>
                    {% if application.tax_id %}
                    <tr>
                        <th>Tax ID:</th>
                        <td>{{ application.tax_id }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <th>Physical Store:</th>
                        <td>
                            {% if application.has_physical_store %}
                            <span class="badge bg-success">‚úÖ Yes</span>
                            {% else %}
                            <span class="badge bg-secondary">‚ùå No</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% if application.has_physical_store and application.physical_address %}
                    <tr>
                        <th>Physical Address:</th>
                        <td>{{ application.physical_address }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Categories & Subcategories -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">üè∑Ô∏è Categories & Subcategories</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>Main Categories:</h6>
                    <div class="d-flex flex-wrap">
                        {% for category in category_names %}
                        <span class="badge badge-category me-2 mb-2 p-2">
                            {{ category.name }}
                            <small class="opacity-75">(ID: {{ category.id }})</small>
                        </span>
                        {% empty %}
                        <span class="text-muted">No categories selected</span>
                        {% endfor %}
                    </div>
                </div>
                
                {% if subcategories %}
                <div class="mb-3">
                    <h6>Subcategories:</h6>
                    <div class="d-flex flex-wrap">
                        {% for subcategory in subcategories %}
                        <span class="badge badge-subcategory me-2 mb-2 p-2">
                            {{ subcategory.name }}
                            <small class="opacity-75">(ID: {{ subcategory.id }})</small>
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Social Media -->
        {% if application.social_media %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">üåê Social Media</h5>
            </div>
            <div class="card-body">
                {% for platform, url in application.social_media.items %}
                    {% if url %}
                    <a href="{{ url }}" target="_blank" class="social-link">
                        {% if platform == 'facebook' %}üìò Facebook
                        {% elif platform == 'instagram' %}üì∑ Instagram  
                        {% elif platform == 'behance' %}üé® Behance
                        {% else %}üîó {{ platform|capfirst }}
                        {% endif %}
                    </a>
                    {% endif %}
                {% empty %}
                <p class="text-muted">No social media links provided</p>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Shipping Information -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between">
                <h5 class="mb-0">üöö Shipping Information</h5>
                <span class="badge bg-info">{{ shipping_stats.available }}/{{ shipping_stats.total }} Available</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-success">‚úÖ Available Shipping:</h6>
                        <ul class="list-unstyled">
                            {% for shipping in shipping_costs_with_names %}
                                {% if shipping.available %}
                                <li class="shipping-available">{{ shipping.name }}: {{ shipping.cost }} EGP</li>
                                {% endif %}
                            {% empty %}
                            <li class="text-muted">No available shipping locations</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-danger">‚ùå Not Available:</h6>
                        <ul class="list-unstyled">
                            {% for shipping in shipping_costs_with_names %}
                                {% if not shipping.available %}
                                <li class="shipping-unavailable">{{ shipping.name }}</li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- ID Documents -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">üÜî ID Documents</h5>
            </div>
            <div class="card-body text-center">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Front ID</h6>
                        {% if application.id_front %}
                        <a href="{{ application.id_front.url }}" target="_blank">
                            <img src="{{ application.id_front.url }}" alt="ID Front" class="img-fluid id-document">
                        </a>
                        {% else %}
                        <div class="alert alert-warning">No front ID uploaded</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <h6>Back ID</h6>
                        {% if application.id_back %}
                        <a href="{{ application.id_back.url }}" target="_blank">
                            <img src="{{ application.id_back.url }}" alt="ID Back" class="img-fluid id-document">
                        </a>
                        {% else %}
                        <div class="alert alert-warning">No back ID uploaded</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Details -->
        {% if application.details %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">üìù Additional Details</h5>
            </div>
            <div class="card-body">
                <pre class="bg-light p-3 rounded">{{ application.details }}</pre>
            </div>
        </div>
        {% endif %}
                
        <!-- Process Application -->
        {% if application.status == 'pending' %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">‚ö° Process Application</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'admin_panel:process_application' application.id %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="admin_notes" class="form-label">Admin Notes</label>
                        <textarea class="form-control" id="admin_notes" name="admin_notes" rows="4" 
                                  placeholder="Add notes about this application..."></textarea>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" name="action" value="approve" class="btn btn-success btn-lg">
                            ‚úÖ Approve Application
                        </button>
                        <button type="submit" name="action" value="reject" class="btn btn-warning">
                            ‚ùå Reject (Can Reapply)
                        </button>
                        <button type="submit" name="action" value="reject_permanently" class="btn btn-danger">
                            üö´ Reject Permanently
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
        
        <!-- Admin Notes & Status -->
        {% if application.admin_notes or application.processed_at %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">üìù Admin Notes & Processing</h5>
            </div>
            <div class="card-body">
                {% if application.admin_notes %}
                <div class="alert alert-info">
                    <strong>Admin Notes:</strong><br>
                    {{ application.admin_notes|linebreaks }}
                </div>
                {% endif %}
                
                {% if application.processed_at %}
                <div class="text-muted">
                    <small>
                        <i class="fas fa-clock"></i> 
                        Processed on {{ application.processed_at|date:"F d, Y H:i" }}
                        {% if application.processed_by %}
                        by <strong>{{ application.processed_by.email }}</strong>
                        {% endif %}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- User Information Card -->
        <div class="card mb-4">
            <div class="card-header">
                User Information
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <i class="fas fa-user-circle fa-5x text-muted"></i>
                </div>
                <table class="table table-borderless">
                    <tr>
                        <th>Name:</th>
                        <td>{{ application.user.first_name }} {{ application.user.last_name }}</td>
                    </tr>
                    <tr>
                        <th>Email:</th>
                        <td>{{ application.user.email }}</td>
                    </tr>
                    <tr>
                        <th>Joined:</th>
                        <td>{{ application.user.date_joined|date:"F d, Y" }}</td>
                    </tr>
                </table>
                <a href="#" class="btn btn-outline-purple w-100">
                    <i class="fas fa-user me-1"></i> View User Profile
                </a>
            </div>
        </div>
        
        <!-- Actions Card -->
        <div class="card">
            <div class="card-header">
                Actions
            </div>
            <div class="card-body">
                <a href="{% url 'admin_panel:seller_applications' %}" class="btn btn-outline-secondary w-100 mb-2">
                    <i class="fas fa-arrow-left me-1"></i> Back to Applications
                </a>
                
                {% if application.status == 'rejected' %}
                <button class="btn btn-outline-success w-100 mb-2" data-bs-toggle="modal" data-bs-target="#reconsiderModal">
                    <i class="fas fa-sync-alt me-1"></i> Reconsider Application
                </button>
                {% endif %}
                
                <button class="btn btn-outline-danger w-100">
                    <i class="fas fa-trash-alt me-1"></i> Delete Application
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reconsider Modal -->
{% if application.status == 'rejected' %}
<div class="modal fade" id="reconsiderModal" tabindex="-1" aria-labelledby="reconsiderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reconsiderModalLabel">Reconsider Application</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to reconsider this application? This will reset the status to 'pending'.</p>
                <form method="post" action="#">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="reconsiderNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="reconsiderNotes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %} 